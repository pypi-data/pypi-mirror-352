# ==============================================================================
# Python pipeline for ncw
# using components
# ==============================================================================

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE != "merge_request_event"


include:
  - component: $CI_SERVER_FQDN/blackstream-x/generic-components/meta-gitlab-security@~latest
  - component: $CI_SERVER_FQDN/blackstream-x/python-components/meta-uv-pipeline@feature/uv-version
    inputs:
      module-name: ncw
      uv-version: "0.7.8"
      mypy-args: "--exclude tools/"
      python-version: "3.13"
      python-variant: "alpine"
      pylint-args: "--disable=fixme --report=yes"
      relax-pylint: true
      pytest-rules:
        - if: $CI_COMMIT_TAG == null
      pytest-matrix:
        - TEST_PYTHON_VERSION: ["3.10", "3.11", "3.12"]
      publish-rules:
        - when: never


stages:
  - codestyle
  - test
  - pre-build
  - build
  - upload
  - bump-prepare
  - bump-push


.release-base:
  # Abstract base job for "release" jobs.
  # Extending jobs must define the following variables:
  # - PYPI_OIDC_AUD: Audience for the ID token that GitLab
  #   issues to the pipeline job
  # - PYPI_OIDC_URL: PyPI endpoint for retrieving a publish
  #   token with GitLabâ€™s ID token
  # - UV_PUBLISH_URL: PyPI endpoint for the actual upload
  stage: 'upload'
  extends: .uv:patch-version
  id_tokens:
    PYPI_ID_TOKEN:
      aud: '$PYPI_OIDC_AUD'
  script:
    # Use the GitLab ID token to retrieve an API token from PyPI
    - publish_token=$(uv run tools/ci_get_pypi_token.py)
    # Upload the files from "dist/"
    - uv publish --token "$publish_token"
    # Print the link to PyPI so we can quickly go there to verify the result:
    - version="$(uv version --short)"
    - 'echo -e "\033[34;1mPackage on PyPI:\033[0m ${CI_ENVIRONMENT_URL}${version}/"'


release-test:
  extends: '.release-base'
  rules:
    # Run in the default branch only
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  environment:
    name: 'release-test'
    url: 'https://test.pypi.org/project/ncw/'
  variables:
    PYPI_OIDC_AUD: 'testpypi'
    PYPI_OIDC_URL: 'https://test.pypi.org/_/oidc/mint-token'
    UV_PUBLISH_URL: 'https://test.pypi.org/legacy/'
  artifacts:


release:
  extends: '.release-base'
  rules:
    # Only run in tag pipelines:
    - if: '$CI_COMMIT_TAG'
  environment:
    name: 'release'
    url: 'https://pypi.org/project/ncw/'
  variables:
    PYPI_OIDC_AUD: 'pypi'
    PYPI_OIDC_URL: 'https://pypi.org/_/oidc/mint-token'
    UV_PUBLISH_URL: 'https://upload.pypi.org/legacy/'


bump-version:
  stage: 'bump-prepare'
  extends: .uv:patch-version
  rules:
    # Run in the default branch only
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - uv version --bump patch
    - new_version="$(uv version --short)"
    - |-
      cat <<EOT | tee new-version.env
      NEW_PACKAGE_VERSION=${new_version}
      EOT
  artifacts:
    reports:
      dotenv: new-version.env
    paths:
      - pyproject.toml


push-new-version:
  image: 'registry.gitlab.com/blackstream-x/saki/alpine:latest'
  stage: 'bump-push'
  rules:
    # Run in the default branch only
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  dependencies:
    - bump-version
  script:
    # Configure user data and cretdentials, and set origin URL
    - git config --global user.name "$GITLAB_USER_NAME"
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - 'echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config'
    - 'git remote set-url origin git@gitlab.com:blackstream-x/ncw.git'
    # Test the configuration (should echo "up dto date")
    - git fetch --prune
    - git checkout $CI_DEFAULT_BRANCH
    - git pull
    # Commit pyproject.toml changes and push
    - git status --porcelain
    - new_branch_name=update/${NEW_PACKAGE_VERSION}
    - echo "Creating new branch ${new_branch_name} ..."
    - git checkout -b ${new_branch_name}
    - git add pyproject.toml
    - git status
    - git commit -m "Bump version to ${NEW_PACKAGE_VERSION}"
    - git push -o ci.skip --set-upstream origin ${new_branch_name}
  allow_failure: true
