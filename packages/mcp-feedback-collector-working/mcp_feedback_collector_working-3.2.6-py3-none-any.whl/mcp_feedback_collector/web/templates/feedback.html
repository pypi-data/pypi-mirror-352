{% extends "base.html" %}

{% block title %}AIå·¥ä½œæ±‡æŠ¥ä¸åé¦ˆæ”¶é›†{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ’¬ AIå·¥ä½œæ±‡æŠ¥ä¸åé¦ˆæ”¶é›†</h1>
    <p class="page-subtitle">æŸ¥çœ‹AIå·¥ä½œæ±‡æŠ¥ï¼Œæä¾›æ‚¨çš„å®è´µåé¦ˆ</p>
</div>

<div class="page-content">
    <!-- å·¥ä½œæ±‡æŠ¥åŒºåŸŸ -->
    <div class="report-section">
        <div class="card">
            <div class="card-header">ğŸ¤– AIå·¥ä½œæ±‡æŠ¥</div>
            <div class="report-content" id="reportContent">
                {{ work_summary | safe }}
            </div>
        </div>
    </div>

    <!-- åé¦ˆè¾“å…¥åŒºåŸŸ -->
    <div class="feedback-section">
        <div class="card">
            <div class="card-header">ğŸ’¬ æ‚¨çš„åé¦ˆï¼ˆå¯é€‰ï¼‰</div>
            
            <!-- æ–‡å­—åé¦ˆ -->
            <div class="text-feedback">
                <textarea 
                    id="feedbackText" 
                    class="form-control" 
                    placeholder="è¯·è¾“å…¥æ‚¨çš„åé¦ˆæ„è§..."
                    rows="6"
                ></textarea>
            </div>

            <!-- å›¾ç‰‡åé¦ˆ -->
            <div class="image-feedback">
                <div class="image-section-header">
                    <span>ğŸ–¼ï¸ å›¾ç‰‡åé¦ˆï¼ˆå¯é€‰ï¼‰</span>
                    <span class="image-count">0/5</span>
                </div>
                
                <!-- å·¥å…·æ  -->
                <div class="toolbar">
                    <button type="button" class="toolbar-button" id="selectImagesBtn">
                        ğŸ“ é€‰æ‹©æ–‡ä»¶
                    </button>
                    <button type="button" class="toolbar-button" id="pasteImageBtn">
                        ğŸ“‹ ç²˜è´´å›¾ç‰‡
                    </button>
                    <button type="button" class="toolbar-button" id="clearImagesBtn">
                        ğŸ—‘ï¸ æ¸…ç©ºå›¾ç‰‡
                    </button>
                </div>

                <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
                <div class="image-preview-area" id="imagePreviewArea">
                    <div class="drop-zone" id="dropZone">
                        <div class="drop-zone-content">
                            <div class="drop-zone-icon">ğŸ“·</div>
                            <div class="drop-zone-text">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
                            <div class="drop-zone-hint">æˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©å›¾ç‰‡</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <div class="submit-section">
                <div class="toolbar">
                    <button type="button" class="btn btn-success" id="submitBtn">
                        âœ… æäº¤åé¦ˆ
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelBtn">
                        âŒ å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
<input type="file" id="fileInput" multiple accept="image/*" style="display: none;">

<!-- çŠ¶æ€æç¤º -->
<div id="statusMessage" class="status-message"></div>
{% endblock %}

{% block extra_css %}
<style>
    .report-section {
        margin-bottom: 20px;
    }
    
    .report-content {
        background-color: #2a2a2a;
        border-radius: 6px;
        padding: 20px;
        line-height: 1.6;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .feedback-section .card {
        background-color: #1e1e1e;
    }
    
    .text-feedback {
        margin-bottom: 20px;
    }
    
    .text-feedback textarea {
        resize: vertical;
        min-height: 120px;
    }
    
    .image-feedback {
        margin-bottom: 20px;
    }
    
    .image-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        font-weight: 500;
    }
    
    .image-count {
        color: #0078d4;
        font-weight: bold;
    }
    
    .image-preview-area {
        min-height: 120px;
        border: 2px dashed #404040;
        border-radius: 8px;
        margin-top: 15px;
        position: relative;
        transition: all 0.3s ease;
    }
    
    .image-preview-area.drag-over {
        border-color: #0078d4;
        background-color: rgba(0, 120, 212, 0.1);
    }
    
    .drop-zone {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 120px;
        text-align: center;
    }
    
    .drop-zone-content {
        color: #888888;
    }
    
    .drop-zone-icon {
        font-size: 32px;
        margin-bottom: 10px;
    }
    
    .drop-zone-text {
        font-size: 16px;
        margin-bottom: 5px;
    }
    
    .drop-zone-hint {
        font-size: 12px;
        color: #666666;
    }
    
    .image-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 15px;
    }
    
    .image-tag {
        position: relative;
        background-color: #2a2a2a;
        border: 1px solid #404040;
        border-radius: 8px;
        padding: 10px;
        width: 120px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .image-tag:hover {
        border-color: #0078d4;
    }
    
    .image-tag img {
        width: 100px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 8px;
    }
    
    .image-tag-name {
        font-size: 12px;
        color: #cccccc;
        word-break: break-all;
        line-height: 1.2;
    }
    
    .image-tag-delete {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 20px;
        height: 20px;
        background-color: #d13438;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .image-tag-delete:hover {
        background-color: #b52d30;
    }
    
    .submit-section {
        border-top: 1px solid #333333;
        padding-top: 20px;
    }
    
    .status-message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }
    
    .status-message.show {
        transform: translateX(0);
    }
    
    .status-message.success {
        background-color: #4CAF50;
    }
    
    .status-message.error {
        background-color: #f44336;
    }
    
    .status-message.warning {
        background-color: #ff9800;
    }
    
    .status-message.info {
        background-color: #2196F3;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .image-tags {
            justify-content: center;
        }
        
        .toolbar {
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .toolbar-button, .btn {
            flex: 1;
            min-width: 120px;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
// åé¦ˆæ”¶é›†é¡µé¢JavaScripté€»è¾‘
class FeedbackCollector {
    constructor() {
        this.selectedImages = [];
        this.maxImages = 5;
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.updateImageCount();
    }
    
    bindEvents() {
        // æ–‡ä»¶é€‰æ‹©
        document.getElementById('selectImagesBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        
        document.getElementById('fileInput').addEventListener('change', (e) => {
            this.handleFileSelect(e.target.files);
        });
        
        // ç²˜è´´å›¾ç‰‡
        document.getElementById('pasteImageBtn').addEventListener('click', () => {
            this.pasteFromClipboard();
        });
        
        // æ¸…ç©ºå›¾ç‰‡
        document.getElementById('clearImagesBtn').addEventListener('click', () => {
            this.clearImages();
        });
        
        // æ‹–æ‹½æ”¯æŒ
        const dropZone = document.getElementById('dropZone');
        const previewArea = document.getElementById('imagePreviewArea');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            previewArea.addEventListener(eventName, this.preventDefaults, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            previewArea.addEventListener(eventName, () => {
                previewArea.classList.add('drag-over');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            previewArea.addEventListener(eventName, () => {
                previewArea.classList.remove('drag-over');
            }, false);
        });
        
        previewArea.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            this.handleFileSelect(files);
        }, false);
        
        // æäº¤å’Œå–æ¶ˆ
        document.getElementById('submitBtn').addEventListener('click', () => {
            this.submitFeedback();
        });
        
        document.getElementById('cancelBtn').addEventListener('click', () => {
            this.cancelFeedback();
        });
        
        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'v') {
                e.preventDefault();
                this.pasteFromClipboard();
            } else if (e.key === 'Escape') {
                this.cancelFeedback();
            } else if (e.ctrlKey && e.key === 'Enter') {
                this.submitFeedback();
            }
        });
    }
    
    preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    handleFileSelect(files) {
        for (let file of files) {
            if (this.selectedImages.length >= this.maxImages) {
                this.showMessage('æœ€å¤šåªèƒ½é€‰æ‹©5å¼ å›¾ç‰‡', 'warning');
                break;
            }
            
            if (file.type.startsWith('image/')) {
                this.addImage(file);
            }
        }
    }
    
    addImage(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const imageData = {
                name: file.name,
                data: e.target.result,
                size: file.size
            };
            
            this.selectedImages.push(imageData);
            this.updateImagePreview();
            this.updateImageCount();
        };
        reader.readAsDataURL(file);
    }
    
    async pasteFromClipboard() {
        try {
            const clipboardItems = await navigator.clipboard.read();
            
            for (const clipboardItem of clipboardItems) {
                for (const type of clipboardItem.types) {
                    if (type.startsWith('image/')) {
                        const blob = await clipboardItem.getType(type);
                        const file = new File([blob], 'clipboard.png', { type: blob.type });
                        this.addImage(file);
                        return;
                    }
                }
            }
            
            this.showMessage('å‰ªè´´æ¿ä¸­æ²¡æœ‰å›¾ç‰‡æ•°æ®', 'warning');
        } catch (err) {
            this.showMessage('æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·ä½¿ç”¨æ–‡ä»¶é€‰æ‹©æˆ–æ‹–æ‹½', 'error');
        }
    }
    
    clearImages() {
        this.selectedImages = [];
        this.updateImagePreview();
        this.updateImageCount();
        this.showMessage('å·²æ¸…ç©ºæ‰€æœ‰å›¾ç‰‡', 'info');
    }
    
    removeImage(index) {
        this.selectedImages.splice(index, 1);
        this.updateImagePreview();
        this.updateImageCount();
    }
    
    updateImagePreview() {
        const previewArea = document.getElementById('imagePreviewArea');
        
        if (this.selectedImages.length === 0) {
            previewArea.innerHTML = `
                <div class="drop-zone" id="dropZone">
                    <div class="drop-zone-content">
                        <div class="drop-zone-icon">ğŸ“·</div>
                        <div class="drop-zone-text">æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
                        <div class="drop-zone-hint">æˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©å›¾ç‰‡</div>
                    </div>
                </div>
            `;
        } else {
            const tagsHtml = this.selectedImages.map((img, index) => `
                <div class="image-tag">
                    <button class="image-tag-delete" onclick="feedbackCollector.removeImage(${index})">Ã—</button>
                    <img src="${img.data}" alt="${img.name}">
                    <div class="image-tag-name">${img.name}</div>
                </div>
            `).join('');
            
            previewArea.innerHTML = `<div class="image-tags">${tagsHtml}</div>`;
        }
    }
    
    updateImageCount() {
        document.querySelector('.image-count').textContent = `${this.selectedImages.length}/${this.maxImages}`;
    }
    
    async submitFeedback() {
        const textContent = document.getElementById('feedbackText').value.trim();
        
        if (!textContent && this.selectedImages.length === 0) {
            this.showMessage('è¯·æä¾›æ–‡å­—åé¦ˆæˆ–å›¾ç‰‡åé¦ˆ', 'warning');
            return;
        }
        
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'â³ æäº¤ä¸­...';
        
        try {
            const response = await fetch('/api/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    text: textContent,
                    images: this.selectedImages.map(img => img.data)
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                this.showMessage('åé¦ˆæäº¤æˆåŠŸï¼', 'success');
                setTimeout(() => {
                    window.close() || (window.location.href = '/');
                }, 2000);
            } else {
                this.showMessage(result.message || 'æäº¤å¤±è´¥', 'error');
            }
        } catch (error) {
            this.showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'âœ… æäº¤åé¦ˆ';
        }
    }
    
    cancelFeedback() {
        if (confirm('ç¡®å®šè¦å–æ¶ˆå—ï¼Ÿæœªä¿å­˜çš„å†…å®¹å°†ä¸¢å¤±ã€‚')) {
            window.close() || (window.location.href = '/');
        }
    }
    
    showMessage(text, type = 'info') {
        const messageEl = document.getElementById('statusMessage');
        messageEl.textContent = text;
        messageEl.className = `status-message ${type} show`;
        
        setTimeout(() => {
            messageEl.classList.remove('show');
        }, 3000);
    }
}

// åˆå§‹åŒ–
const feedbackCollector = new FeedbackCollector();
</script>
{% endblock %}
