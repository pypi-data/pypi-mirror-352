{% extends "base.html" %}

{% block title %}AIæ™ºèƒ½èŠå¤©{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">ğŸ¤– AIæ™ºèƒ½èŠå¤©</h1>
    <p class="page-subtitle">ä¸AIè¿›è¡Œå¤šæ¨¡æ€æ™ºèƒ½å¯¹è¯</p>
</div>

<div class="page-content chat-container">
    <!-- èŠå¤©è®°å½•åŒºåŸŸ -->
    <div class="chat-area" id="chatArea">
        <div class="chat-messages" id="chatMessages">
            {% if not success %}
            <div class="system-message error">
                <div class="message-content">
                    âŒ {{ message }}
                    {% if need_api_key %}
                    <div class="api-key-hint">
                        <p>éœ€è¦APIå¯†é’¥æ¥ä½¿ç”¨AIèŠå¤©åŠŸèƒ½</p>
                        <a href="https://api.ssopen.top/" target="_blank" class="btn btn-primary">
                            ğŸ”‘ è·å–APIå¯†é’¥
                        </a>
                        <p style="margin-top: 10px; font-size: 12px; color: #888;">
                            è·å–å¯†é’¥åï¼Œè¯·åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½® MCP_API_KEY
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="system-message">
                <div class="message-content">
                    ğŸ¯ æ¬¢è¿ä½¿ç”¨AIæ™ºèƒ½èŠå¤©ï¼<br>
                    æ”¯æŒæ–‡å­—å’Œå›¾ç‰‡å¤šæ¨¡æ€å¯¹è¯ï¼Œå®æ—¶æµå¼å“åº”ã€‚
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="input-area" id="inputArea">
        <!-- å›¾ç‰‡é¢„è§ˆ -->
        <div class="image-preview" id="imagePreview" style="display: none;">
            <div class="image-preview-header">
                <span>ğŸ“· å·²é€‰æ‹©çš„å›¾ç‰‡</span>
                <button type="button" class="btn-clear-images" id="clearImagesBtn">æ¸…ç©º</button>
            </div>
            <div class="image-preview-list" id="imagePreviewList"></div>
        </div>

        <!-- è¾“å…¥æ¡†å’Œå·¥å…·æ  -->
        <div class="input-container">
            <div class="input-wrapper">
                <textarea 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="è¾“å…¥æ¶ˆæ¯..."
                    rows="1"
                ></textarea>
                <div class="input-toolbar">
                    <button type="button" class="toolbar-btn" id="selectImageBtn" title="é€‰æ‹©å›¾ç‰‡">
                        ğŸ“·
                    </button>
                    <button type="button" class="toolbar-btn" id="pasteImageBtn" title="ç²˜è´´å›¾ç‰‡">
                        ğŸ“‹
                    </button>
                    <button type="button" class="toolbar-btn" id="clearChatBtn" title="æ¸…ç©ºèŠå¤©">
                        ğŸ—‘ï¸
                    </button>
                    <button type="button" class="toolbar-btn send-btn" id="sendBtn" title="å‘é€æ¶ˆæ¯">
                        ğŸš€
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
<input type="file" id="fileInput" multiple accept="image/*" style="display: none;">

<!-- çŠ¶æ€æç¤º -->
<div id="statusMessage" class="status-message"></div>
{% endblock %}

{% block extra_js %}
<script>
// AIèŠå¤©é¡µé¢JavaScripté€»è¾‘
class ChatInterface {
    constructor() {
        this.socket = null;
        this.selectedImages = [];
        this.messageHistory = [];
        this.currentAIMessage = null;
        this.isConnected = false;
        this.maxImages = 5;

        this.init();
    }

    init() {
        this.initSocket();
        this.bindEvents();
        this.autoResizeTextarea();
    }

    initSocket() {
        this.socket = io();

        this.socket.on('connect', () => {
            this.isConnected = true;
            this.showMessage('å·²è¿æ¥åˆ°æœåŠ¡å™¨', 'success');
        });

        this.socket.on('disconnect', () => {
            this.isConnected = false;
            this.showMessage('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥', 'error');
        });

        this.socket.on('user_message', (data) => {
            this.addMessage(data.message, 'user', data.timestamp);
        });

        this.socket.on('ai_message_start', () => {
            this.currentAIMessage = this.addTypingIndicator();
        });

        this.socket.on('ai_message_chunk', (data) => {
            this.updateAIMessage(data.content);
        });

        this.socket.on('ai_message_complete', () => {
            this.completeAIMessage();
        });

        this.socket.on('ai_message_error', (data) => {
            this.showMessage(data.error, 'error');
            this.removeTypingIndicator();
        });

        this.socket.on('chat_cleared', () => {
            this.clearChatMessages();
            this.showMessage('èŠå¤©è®°å½•å·²æ¸…ç©º', 'info');
        });

        this.socket.on('error', (data) => {
            this.showMessage(data.message, 'error');
        });
    }

    bindEvents() {
        // å‘é€æ¶ˆæ¯
        document.getElementById('sendBtn').addEventListener('click', () => {
            this.sendMessage();
        });

        // è¾“å…¥æ¡†å›è½¦å‘é€
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        // å›¾ç‰‡é€‰æ‹©
        document.getElementById('selectImageBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            this.handleFileSelect(e.target.files);
        });

        // ç²˜è´´å›¾ç‰‡
        document.getElementById('pasteImageBtn').addEventListener('click', () => {
            this.pasteFromClipboard();
        });

        // æ¸…ç©ºå›¾ç‰‡
        document.getElementById('clearImagesBtn').addEventListener('click', () => {
            this.clearSelectedImages();
        });

        // æ¸…ç©ºèŠå¤©
        document.getElementById('clearChatBtn').addEventListener('click', () => {
            this.clearChat();
        });

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'v') {
                e.preventDefault();
                this.pasteFromClipboard();
            }
        });
    }

    autoResizeTextarea() {
        const textarea = document.getElementById('messageInput');
        textarea.addEventListener('input', () => {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        });
    }

    async sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const text = messageInput.value.trim();

        if (!text && this.selectedImages.length === 0) {
            this.showMessage('è¯·è¾“å…¥æ¶ˆæ¯æˆ–é€‰æ‹©å›¾ç‰‡', 'warning');
            return;
        }

        if (!this.isConnected) {
            this.showMessage('æœªè¿æ¥åˆ°æœåŠ¡å™¨', 'error');
            return;
        }

        // ç¦ç”¨å‘é€æŒ‰é’®
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = true;

        try {
            // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
            this.socket.emit('send_message', {
                text: text,
                images: this.selectedImages.map(img => img.data),
                history: this.messageHistory
            });

            // æ¸…ç©ºè¾“å…¥
            messageInput.value = '';
            messageInput.style.height = 'auto';
            this.clearSelectedImages();

        } catch (error) {
            this.showMessage('å‘é€æ¶ˆæ¯å¤±è´¥', 'error');
        } finally {
            sendBtn.disabled = false;
        }
    }

    addMessage(message, type, timestamp) {
        const messagesContainer = document.getElementById('chatMessages');
        const messageEl = document.createElement('div');
        messageEl.className = `message ${type}`;

        let content = '';
        if (typeof message === 'string') {
            content = message;
        } else if (message.content) {
            if (Array.isArray(message.content)) {
                // å¤šæ¨¡æ€æ¶ˆæ¯
                const textParts = message.content.filter(part => part.type === 'text');
                const imageParts = message.content.filter(part => part.type === 'image_url');

                content = textParts.map(part => part.text).join('\n');

                if (imageParts.length > 0) {
                    const imagesHtml = imageParts.map(part =>
                        `<img src="${part.image_url.url}" class="message-image" onclick="this.requestFullscreen()">`
                    ).join('');
                    content += `<div class="message-images">${imagesHtml}</div>`;
                }
            } else {
                content = message.content;
            }
        }

        const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();

        messageEl.innerHTML = `
            <div class="message-bubble">
                <div class="message-content">${content}</div>
                <div class="message-timestamp">${timeStr}</div>
            </div>
        `;

        messagesContainer.appendChild(messageEl);
        this.scrollToBottom();

        // æ·»åŠ åˆ°å†å²è®°å½•
        if (typeof message === 'object') {
            this.messageHistory.push(message);
        } else {
            this.messageHistory.push({
                role: type === 'user' ? 'user' : 'assistant',
                content: message
            });
        }
    }

    addTypingIndicator() {
        const messagesContainer = document.getElementById('chatMessages');
        const typingEl = document.createElement('div');
        typingEl.className = 'message ai typing';
        typingEl.innerHTML = `
            <div class="message-bubble">
                <div class="typing-indicator">
                    <span>AIæ­£åœ¨å›å¤</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        `;

        messagesContainer.appendChild(typingEl);
        this.scrollToBottom();

        return typingEl;
    }

    updateAIMessage(content) {
        if (!this.currentAIMessage) return;

        // å¦‚æœè¿˜æ˜¯æ‰“å­—æŒ‡ç¤ºå™¨ï¼Œæ›¿æ¢ä¸ºå®é™…æ¶ˆæ¯
        if (this.currentAIMessage.classList.contains('typing')) {
            this.currentAIMessage.classList.remove('typing');
            this.currentAIMessage.innerHTML = `
                <div class="message-bubble">
                    <div class="message-content"></div>
                    <div class="message-timestamp">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
        }

        const contentEl = this.currentAIMessage.querySelector('.message-content');
        if (contentEl) {
            contentEl.textContent += content;
            this.scrollToBottom();
        }
    }

    completeAIMessage() {
        if (this.currentAIMessage) {
            const contentEl = this.currentAIMessage.querySelector('.message-content');
            if (contentEl) {
                // æ·»åŠ åˆ°å†å²è®°å½•
                this.messageHistory.push({
                    role: 'assistant',
                    content: contentEl.textContent
                });
            }
        }
        this.currentAIMessage = null;
    }

    removeTypingIndicator() {
        if (this.currentAIMessage && this.currentAIMessage.classList.contains('typing')) {
            this.currentAIMessage.remove();
            this.currentAIMessage = null;
        }
    }

    handleFileSelect(files) {
        for (let file of files) {
            if (this.selectedImages.length >= this.maxImages) {
                this.showMessage('æœ€å¤šåªèƒ½é€‰æ‹©5å¼ å›¾ç‰‡', 'warning');
                break;
            }

            if (file.type.startsWith('image/')) {
                this.addSelectedImage(file);
            }
        }
    }

    addSelectedImage(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const imageData = {
                name: file.name,
                data: e.target.result,
                size: file.size
            };

            this.selectedImages.push(imageData);
            this.updateImagePreview();
        };
        reader.readAsDataURL(file);
    }

    async pasteFromClipboard() {
        try {
            const clipboardItems = await navigator.clipboard.read();

            for (const clipboardItem of clipboardItems) {
                for (const type of clipboardItem.types) {
                    if (type.startsWith('image/')) {
                        const blob = await clipboardItem.getType(type);
                        const file = new File([blob], 'clipboard.png', { type: blob.type });
                        this.addSelectedImage(file);
                        return;
                    }
                }
            }

            this.showMessage('å‰ªè´´æ¿ä¸­æ²¡æœ‰å›¾ç‰‡æ•°æ®', 'warning');
        } catch (err) {
            this.showMessage('æ— æ³•è®¿é—®å‰ªè´´æ¿', 'error');
        }
    }

    clearSelectedImages() {
        this.selectedImages = [];
        this.updateImagePreview();
    }

    updateImagePreview() {
        const previewContainer = document.getElementById('imagePreview');
        const previewList = document.getElementById('imagePreviewList');

        if (this.selectedImages.length === 0) {
            previewContainer.style.display = 'none';
        } else {
            previewContainer.style.display = 'block';

            const imagesHtml = this.selectedImages.map((img, index) => `
                <div class="preview-image-item">
                    <img src="${img.data}" class="preview-image" alt="${img.name}">
                    <button class="preview-image-delete" onclick="chatInterface.removeSelectedImage(${index})">Ã—</button>
                </div>
            `).join('');

            previewList.innerHTML = imagesHtml;
        }
    }

    removeSelectedImage(index) {
        this.selectedImages.splice(index, 1);
        this.updateImagePreview();
    }

    clearChat() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
            this.socket.emit('clear_chat');
        }
    }

    clearChatMessages() {
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.innerHTML = `
            <div class="system-message">
                <div class="message-content">
                    ğŸ¯ èŠå¤©è®°å½•å·²æ¸…ç©ºï¼<br>
                    å¼€å§‹æ–°çš„å¯¹è¯å§ã€‚
                </div>
            </div>
        `;
        this.messageHistory = [];
        this.currentAIMessage = null;
    }

    scrollToBottom() {
        const messagesContainer = document.getElementById('chatMessages');
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 50);
    }

    showMessage(text, type = 'info') {
        const messageEl = document.getElementById('statusMessage');
        messageEl.textContent = text;
        messageEl.className = `status-message ${type} show`;

        setTimeout(() => {
            messageEl.classList.remove('show');
        }, 3000);
    }
}

// åˆå§‹åŒ–èŠå¤©ç•Œé¢
const chatInterface = new ChatInterface();
</script>
{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 120px);
        padding: 0;
    }
    
    .chat-area {
        flex: 1;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .chat-messages {
        height: 100%;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .message {
        display: flex;
        max-width: 80%;
        animation: fadeIn 0.3s ease;
    }
    
    .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
    }
    
    .message.ai {
        align-self: flex-start;
    }
    
    .message-bubble {
        background-color: #2a2a2a;
        border-radius: 12px;
        padding: 12px 16px;
        position: relative;
        word-wrap: break-word;
    }
    
    .message.user .message-bubble {
        background-color: #0078d4;
        color: white;
    }
    
    .message.ai .message-bubble {
        background-color: #2a2a2a;
        color: #e0e0e0;
    }
    
    .message-content {
        line-height: 1.5;
        white-space: pre-wrap;
    }
    
    .message-images {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
    }
    
    .message-image {
        max-width: 200px;
        max-height: 150px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    
    .message-image:hover {
        transform: scale(1.05);
    }
    
    .message-timestamp {
        font-size: 11px;
        color: #888888;
        margin-top: 4px;
        text-align: right;
    }
    
    .message.ai .message-timestamp {
        text-align: left;
    }
    
    .system-message {
        align-self: center;
        text-align: center;
        color: #888888;
        font-style: italic;
        padding: 10px;
        border-radius: 8px;
        background-color: #252525;
        max-width: 60%;
    }
    
    .system-message.error {
        color: #f44336;
        background-color: rgba(244, 67, 54, 0.1);
        border: 1px solid rgba(244, 67, 54, 0.3);
    }
    
    .api-key-hint {
        margin-top: 15px;
        padding: 15px;
        background-color: #2a2a2a;
        border-radius: 6px;
    }
    
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #888888;
        font-style: italic;
    }
    
    .typing-dots {
        display: flex;
        gap: 4px;
    }
    
    .typing-dot {
        width: 6px;
        height: 6px;
        background-color: #888888;
        border-radius: 50%;
        animation: typingDot 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typingDot {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    .input-area {
        background-color: #1e1e1e;
        border-top: 1px solid #333333;
        padding: 20px;
    }
    
    .image-preview {
        margin-bottom: 15px;
        background-color: #252525;
        border-radius: 8px;
        padding: 15px;
    }
    
    .image-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-weight: 500;
    }
    
    .btn-clear-images {
        background: none;
        border: none;
        color: #f44336;
        cursor: pointer;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s ease;
    }
    
    .btn-clear-images:hover {
        background-color: rgba(244, 67, 54, 0.1);
    }
    
    .image-preview-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .preview-image-item {
        position: relative;
        width: 80px;
        height: 80px;
    }
    
    .preview-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 6px;
        border: 2px solid #404040;
    }
    
    .preview-image-delete {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 20px;
        height: 20px;
        background-color: #f44336;
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .input-container {
        background-color: #2a2a2a;
        border-radius: 12px;
        padding: 12px;
    }
    
    .input-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 12px;
    }
    
    .message-input {
        flex: 1;
        background-color: transparent;
        border: none;
        color: #e0e0e0;
        font-size: 14px;
        font-family: inherit;
        resize: none;
        outline: none;
        min-height: 20px;
        max-height: 120px;
        line-height: 1.5;
    }
    
    .message-input::placeholder {
        color: #888888;
    }
    
    .input-toolbar {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    
    .toolbar-btn {
        width: 36px;
        height: 36px;
        background-color: #404040;
        border: none;
        border-radius: 8px;
        color: #e0e0e0;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }
    
    .toolbar-btn:hover {
        background-color: #505050;
    }
    
    .toolbar-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .toolbar-btn.send-btn {
        background-color: #0078d4;
    }
    
    .toolbar-btn.send-btn:hover:not(:disabled) {
        background-color: #106ebe;
    }
    
    .status-message {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 1000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }
    
    .status-message.show {
        transform: translateX(0);
    }
    
    .status-message.success { background-color: #4CAF50; }
    .status-message.error { background-color: #f44336; }
    .status-message.warning { background-color: #ff9800; }
    .status-message.info { background-color: #2196F3; }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }


    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .message {
            max-width: 95%;
        }
        
        .input-toolbar {
            gap: 6px;
        }
        
        .toolbar-btn {
            width: 32px;
            height: 32px;
            font-size: 14px;
        }
        
        .system-message {
            max-width: 90%;
        }
    }
</style>
{% endblock %}
