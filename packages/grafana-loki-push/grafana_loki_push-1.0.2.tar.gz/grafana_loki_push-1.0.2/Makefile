# Makefile - grafana-loki-push é¡¹ç›®ç®¡ç†

# é¡¹ç›®ä¿¡æ¯
PROJECT_NAME := grafana-loki-push

# Pythonå’Œpipè·¯å¾„æ™ºèƒ½æ£€æµ‹
# ä¼˜å…ˆä½¿ç”¨è™šæ‹Ÿç¯å¢ƒä¸­çš„ python å’Œ pip
PYTHON := $(shell which python 2>/dev/null || which python3 2>/dev/null || echo python3)
PIP := $(shell which pip 2>/dev/null || which pip3 2>/dev/null || echo pip3)

# é¢œè‰²å®šä¹‰
BLUE := \033[36m
GREEN := \033[32m
YELLOW := \033[33m
RED := \033[31m
RESET := \033[0m

# ç›®å½•å®šä¹‰
DIST_DIR := dist
BUILD_DIR := build
EGG_INFO_DIRS := $(wildcard *.egg-info)

# ç¯å¢ƒæ£€æµ‹
UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin)
    OS_TYPE := macos
else ifeq ($(UNAME_S),Linux)
    OS_TYPE := linux
else
    OS_TYPE := other
endif

.PHONY: help install install-dev test clean build publish test-publish docs lint format env-check env-setup

# é»˜è®¤ç›®æ ‡
help:
	@echo "$(BLUE)$(PROJECT_NAME) é¡¹ç›®ç®¡ç†å‘½ä»¤$(RESET)"
	@echo ""
	@echo "$(GREEN)ğŸš€ å¿«é€Ÿå¼€å§‹:$(RESET)"
	@echo "  env-check    - æ£€æŸ¥Pythonç¯å¢ƒ"
	@echo "  env-setup    - è®¾ç½®è™šæ‹Ÿç¯å¢ƒï¼ˆæ¨èï¼‰"
	@echo "  setup        - åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ"
	@echo "  release      - ä¸€é”®æµ‹è¯•å‘å¸ƒåˆ° TestPyPI"
	@echo "  publish      - å‘å¸ƒåˆ°æ­£å¼ PyPI"
	@echo ""
	@echo "$(GREEN)ğŸ“¦ å¼€å‘ç¯å¢ƒ:$(RESET)"
	@echo "  install      - å®‰è£…é¡¹ç›®ä¾èµ–"
	@echo "  install-dev  - å®‰è£…å¼€å‘ä¾èµ–"
	@echo "  install-edit - å¯ç¼–è¾‘æ¨¡å¼å®‰è£…"
	@echo ""
	@echo "$(GREEN)ğŸ”§ ä»£ç è´¨é‡:$(RESET)"
	@echo "  test         - è¿è¡Œæµ‹è¯•"
	@echo "  test-package - æµ‹è¯•å·²å®‰è£…çš„åŒ…"
	@echo "  lint         - ä»£ç æ£€æŸ¥"
	@echo "  format       - ä»£ç æ ¼å¼åŒ–"
	@echo "  type-check   - ç±»å‹æ£€æŸ¥"
	@echo ""
	@echo "$(GREEN)ğŸ—ï¸  æ„å»ºå‘å¸ƒ:$(RESET)"
	@echo "  clean        - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  build        - æ„å»ºåŒ…"
	@echo "  check        - æ£€æŸ¥åŒ…"
	@echo "  test-publish - å‘å¸ƒåˆ°æµ‹è¯•PyPI"
	@echo ""
	@echo "$(GREEN)ğŸ“š æ–‡æ¡£:$(RESET)"
	@echo "  docs         - ç”Ÿæˆæ–‡æ¡£"
	@echo "  docs-serve   - å¯åŠ¨æ–‡æ¡£æœåŠ¡"
	@echo ""
	@echo "$(GREEN)ğŸ” é¡¹ç›®ä¿¡æ¯:$(RESET)"
	@echo "  info         - æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯"
	@echo "  version      - æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"

# ==================== ç¯å¢ƒæ£€æµ‹å’Œè®¾ç½® ====================

env-check:
	@echo "$(BLUE)æ£€æŸ¥Pythonç¯å¢ƒ...$(RESET)"
	@echo "æ“ä½œç³»ç»Ÿ: $(OS_TYPE)"
	@echo "Pythonè·¯å¾„: $$(which $(PYTHON))"
	@echo "Pythonç‰ˆæœ¬: $$($(PYTHON) --version)"
	@echo "pipè·¯å¾„: $$(which $(PIP))"
	@echo "pipç‰ˆæœ¬: $$($(PIP) --version)"
	@if [ "$$VIRTUAL_ENV" != "" ]; then \
		echo "$(GREEN)âœ… å½“å‰åœ¨è™šæ‹Ÿç¯å¢ƒä¸­: $$VIRTUAL_ENV$(RESET)"; \
	elif [ "$$CONDA_DEFAULT_ENV" != "" ]; then \
		echo "$(GREEN)âœ… å½“å‰åœ¨condaç¯å¢ƒä¸­: $$CONDA_DEFAULT_ENV$(RESET)"; \
	else \
		echo "$(YELLOW)âš ï¸  å½“å‰ä½¿ç”¨ç³»ç»ŸPythonï¼Œå»ºè®®ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ$(RESET)"; \
		echo "$(YELLOW)   è¿è¡Œ 'make env-setup' åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ$(RESET)"; \
	fi

env-setup:
	@echo "$(BLUE)è®¾ç½®Pythonè™šæ‹Ÿç¯å¢ƒ...$(RESET)"
	@if [ -d "venv" ]; then \
		echo "$(GREEN)è™šæ‹Ÿç¯å¢ƒå·²å­˜åœ¨$(RESET)"; \
	else \
		echo "$(BLUE)åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ...$(RESET)"; \
		$(PYTHON) -m venv venv; \
		echo "$(GREEN)âœ… è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå®Œæˆ$(RESET)"; \
	fi
	@echo ""
	@echo "$(YELLOW)è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ:$(RESET)"
	@if [ "$(OS_TYPE)" = "macos" ] || [ "$(OS_TYPE)" = "linux" ]; then \
		echo "  source venv/bin/activate"; \
	else \
		echo "  venv\\Scripts\\activate"; \
	fi
	@echo ""
	@echo "$(YELLOW)ç„¶åè¿è¡Œ: make setup$(RESET)"

# ==================== å¿«é€Ÿå¼€å§‹ ====================

setup: env-check install-build-deps install-edit
	@echo "$(GREEN)âœ… å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ$(RESET)"
	@echo "$(YELLOW)ç°åœ¨å¯ä»¥è¿è¡Œ: make release$(RESET)"

release: clean build check test-package test-publish
	@echo "$(GREEN)âœ… æµ‹è¯•å‘å¸ƒå®Œæˆï¼$(RESET)"
	@echo "$(YELLOW)å¦‚æœæµ‹è¯•æ— é—®é¢˜ï¼Œè¿è¡Œ 'make publish' å‘å¸ƒåˆ°æ­£å¼PyPI$(RESET)"

# ==================== å®‰è£…ä¾èµ– ====================

install:
	@echo "$(BLUE)å®‰è£…é¡¹ç›®ä¾èµ–...$(RESET)"
	$(PIP) install -r requirements.txt

install-dev:
	@echo "$(BLUE)å®‰è£…å¼€å‘ä¾èµ–...$(RESET)"
	$(PIP) install -e ".[dev]"

install-edit:
	@echo "$(BLUE)å¯ç¼–è¾‘æ¨¡å¼å®‰è£…...$(RESET)"
	@if [ "$$VIRTUAL_ENV" != "" ]; then \
		echo "$(GREEN)ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒå®‰è£…...$(RESET)"; \
		$(PYTHON) -m pip install -e .; \
	elif [ "$$CONDA_DEFAULT_ENV" != "" ]; then \
		echo "$(GREEN)ä½¿ç”¨condaç¯å¢ƒå®‰è£…...$(RESET)"; \
		$(PYTHON) -m pip install -e .; \
	elif [ "$(OS_TYPE)" = "macos" ]; then \
		echo "$(YELLOW)Macç¯å¢ƒä¸‹ä½¿ç”¨ç”¨æˆ·å®‰è£…...$(RESET)"; \
		$(PYTHON) -m pip install -e . --user --break-system-packages 2>/dev/null || \
		$(PYTHON) -m pip install -e . --user; \
	else \
		echo "$(YELLOW)ä½¿ç”¨ç”¨æˆ·å®‰è£…...$(RESET)"; \
		$(PYTHON) -m pip install -e . --user; \
	fi

install-build-deps:
	@echo "$(BLUE)å®‰è£…æ„å»ºä¾èµ–...$(RESET)"
	@if [ "$$VIRTUAL_ENV" != "" ] || [ "$$CONDA_DEFAULT_ENV" != "" ]; then \
		$(PIP) install build twine setuptools wheel; \
	elif [ "$(OS_TYPE)" = "macos" ]; then \
		$(PIP) install build twine setuptools wheel --user --break-system-packages 2>/dev/null || \
		$(PIP) install build twine setuptools wheel --user; \
	else \
		$(PIP) install build twine setuptools wheel --user; \
	fi

# ==================== ä»£ç è´¨é‡æ£€æŸ¥ ====================

test:
	@echo "$(BLUE)è¿è¡Œæµ‹è¯•...$(RESET)"
	@if [ -d "tests" ]; then \
		$(PYTHON) -m pytest tests/ -v --cov=grafana_loki_push --cov-report=html; \
	else \
		echo "$(YELLOW)âš ï¸  æ²¡æœ‰æ‰¾åˆ°testsç›®å½•ï¼Œè·³è¿‡æµ‹è¯•$(RESET)"; \
	fi

test-package:
	@echo "$(BLUE)æµ‹è¯•å·²å®‰è£…çš„åŒ…...$(RESET)"
	@$(PYTHON) -c "import grafana_loki_push; print('âœ… å¯¼å…¥æˆåŠŸï¼Œç‰ˆæœ¬:', grafana_loki_push.__version__)"
	@$(PYTHON) -c "from grafana_loki_push import LokiHandler, LokiHTTPClient, add_loki_handler; print('âœ… æ ¸å¿ƒç»„ä»¶å¯¼å…¥æˆåŠŸ')"
	@loki-deploy --help > /dev/null && echo "âœ… å‘½ä»¤è¡Œå·¥å…·å¯ç”¨" || echo "âŒ å‘½ä»¤è¡Œå·¥å…·ä¸å¯ç”¨"
	@echo "$(GREEN)âœ… åŒ…æµ‹è¯•å®Œæˆ$(RESET)"

lint:
	@echo "$(BLUE)ä»£ç æ£€æŸ¥...$(RESET)"
	@if command -v flake8 >/dev/null 2>&1; then \
		$(PYTHON) -m flake8 grafana_loki_push/ --max-line-length=88 --extend-ignore=E203,W503; \
		echo "$(GREEN)âœ… ä»£ç æ£€æŸ¥é€šè¿‡$(RESET)"; \
	else \
		echo "$(YELLOW)âš ï¸  flake8 æœªå®‰è£…ï¼Œè·³è¿‡ä»£ç æ£€æŸ¥$(RESET)"; \
	fi

format:
	@echo "$(BLUE)æ ¼å¼åŒ–ä»£ç ...$(RESET)"
	@if command -v black >/dev/null 2>&1; then \
		$(PYTHON) -m black grafana_loki_push/ --line-length 88; \
		echo "$(GREEN)âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ$(RESET)"; \
	else \
		echo "$(YELLOW)âš ï¸  black æœªå®‰è£…ï¼Œè·³è¿‡ä»£ç æ ¼å¼åŒ–$(RESET)"; \
	fi

type-check:
	@echo "$(BLUE)ç±»å‹æ£€æŸ¥...$(RESET)"
	@if command -v mypy >/dev/null 2>&1; then \
		$(PYTHON) -m mypy grafana_loki_push/ --ignore-missing-imports; \
		echo "$(GREEN)âœ… ç±»å‹æ£€æŸ¥é€šè¿‡$(RESET)"; \
	else \
		echo "$(YELLOW)âš ï¸  mypy æœªå®‰è£…ï¼Œè·³è¿‡ç±»å‹æ£€æŸ¥$(RESET)"; \
	fi

# ==================== æ„å»ºå’Œå‘å¸ƒ ====================

clean:
	@echo "$(BLUE)æ¸…ç†æ„å»ºæ–‡ä»¶...$(RESET)"
	@rm -rf $(DIST_DIR) $(BUILD_DIR) $(EGG_INFO_DIRS)
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(RESET)"

build: clean
	@echo "$(BLUE)æ„å»ºåŒ…...$(RESET)"
	@$(PYTHON) -m build
	@echo "$(GREEN)âœ… æ„å»ºå®Œæˆ$(RESET)"
	@echo "$(BLUE)ğŸ“¦ æ„å»ºäº§ç‰©:$(RESET)"
	@ls -la $(DIST_DIR)/

check: 
	@echo "$(BLUE)æ£€æŸ¥åŒ…...$(RESET)"
	@if [ ! -d "$(DIST_DIR)" ] || [ -z "$$(ls -A $(DIST_DIR) 2>/dev/null)" ]; then \
		echo "$(YELLOW)âš ï¸  æœªæ‰¾åˆ°æ„å»ºäº§ç‰©ï¼Œå…ˆæ„å»ºåŒ…...$(RESET)"; \
		$(MAKE) build; \
	fi
	@$(PYTHON) -m twine check $(DIST_DIR)/*
	@echo "$(GREEN)âœ… åŒ…æ£€æŸ¥é€šè¿‡$(RESET)"

test-publish: check
	@echo "$(YELLOW)ğŸš€ å‘å¸ƒåˆ°æµ‹è¯•PyPI...$(RESET)"
	@echo "$(YELLOW)è¯·ç¡®ä¿å·²é…ç½® TestPyPI å‡­æ®$(RESET)"
	@$(PYTHON) -m twine upload --repository testpypi $(DIST_DIR)/*
	@echo "$(GREEN)âœ… å‘å¸ƒåˆ°æµ‹è¯•PyPIæˆåŠŸ!$(RESET)"
	@echo "$(BLUE)ğŸ“¦ æµ‹è¯•å®‰è£…å‘½ä»¤:$(RESET)"
	@$(PYTHON) -c "import grafana_loki_push; print('pip install --index-url https://test.pypi.org/simple/ grafana-loki-push==' + grafana_loki_push.__version__)"

publish: check
	@echo "$(RED)ğŸš€ å‘å¸ƒåˆ°æ­£å¼PyPI...$(RESET)"
	@$(PYTHON) -c "import grafana_loki_push; version = grafana_loki_push.__version__; print(f'å³å°†å‘å¸ƒç‰ˆæœ¬ {version} åˆ°æ­£å¼PyPI')"
	@read -p "ç¡®è®¤å‘å¸ƒå—? (yes/no): " answer && [ "$$answer" = "yes" ]
	@$(PYTHON) -m twine upload $(DIST_DIR)/*
	@echo "$(GREEN)âœ… å‘å¸ƒåˆ°PyPIæˆåŠŸ!$(RESET)"
	@echo "$(BLUE)ğŸ“¦ å®‰è£…å‘½ä»¤:$(RESET)"
	@$(PYTHON) -c "import grafana_loki_push; print('pip install grafana-loki-push==' + grafana_loki_push.__version__)"

# ==================== æ–‡æ¡£ç›¸å…³ ====================

docs:
	@echo "$(BLUE)ç”Ÿæˆæ–‡æ¡£...$(RESET)"
	@echo "$(YELLOW)TODO: æ·»åŠ æ–‡æ¡£ç”Ÿæˆå‘½ä»¤$(RESET)"

docs-serve:
	@echo "$(BLUE)å¯åŠ¨æ–‡æ¡£æœåŠ¡...$(RESET)"
	@echo "$(YELLOW)TODO: æ·»åŠ æ–‡æ¡£æœåŠ¡å‘½ä»¤$(RESET)"

# ==================== é¡¹ç›®ä¿¡æ¯ ====================

info:
	@echo "$(BLUE)é¡¹ç›®ä¿¡æ¯:$(RESET)"
	@echo "  åç§°: $(PROJECT_NAME)"
	@echo "  Pythonç‰ˆæœ¬: $$($(PYTHON) --version)"
	@echo "  é¡¹ç›®è·¯å¾„: $$(pwd)"
	@echo "  è™šæ‹Ÿç¯å¢ƒ: $(VIRTUAL_ENV)"

version:
	@echo "$(BLUE)ç‰ˆæœ¬ä¿¡æ¯:$(RESET)"
	@$(PYTHON) -c "import grafana_loki_push; print(f'å½“å‰ç‰ˆæœ¬: {grafana_loki_push.__version__}')"

# ==================== å¼€å‘æµç¨‹å¿«æ·æ–¹å¼ ====================

dev-setup: install-dev
	@echo "$(GREEN)âœ… å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ$(RESET)"

dev-check: format lint type-check test-package
	@echo "$(GREEN)âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ$(RESET)"

dev-build: clean build check
	@echo "$(GREEN)âœ… æ„å»ºå®Œæˆ$(RESET)" 