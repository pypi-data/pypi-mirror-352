# PyBEST: Pythonic Black-box Electronic Structure Tool
# Copyright (C) 2016-- The PyBEST Development Team
#
# This file is part of PyBEST.
#
# PyBEST is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# PyBEST is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
# --

#
# Detailed changelog:
#
# 2025-05-23: scalar relativistic hamiltonians tests implementation (Kacper Cieslak)
#

from typing import Any

import numpy as np
import pytest

from pybest import context
from pybest.gbasis.gobasis import Basis, get_gobasis


# reference integral data for dkh h20 test
def dkhn_h2o_reference_data() -> (
    tuple[int, np.ndarray[Any, Any], Basis, float, float]
):
    """Reference integral data for dkh2 h2o test

    Returns:
        tuple:
            int: integral matrix size
            np.ndarray: integral matrix
            Basis: basis instance
            np.double: relative tolerance
            np.double: absolute tolerance
    """
    smallref_array = np.array(
        [
            [
                -3.30737401e01,
                4.01129721e00,
                -5.92887572e00,
                -1.48134665e-17,
                6.62313701e-15,
                -2.06875540e-02,
                -1.20642164e-15,
                -9.10889830e-17,
                -5.64010193e-03,
                -1.72295788e-28,
                8.64568564e-19,
                -3.41894315e-04,
                -3.44427071e-15,
                -3.32408521e-03,
                -9.37574577e-01,
                -2.09593159e00,
                -2.63593130e00,
                2.30025211e-16,
                2.02149920e00,
                -9.37574577e-01,
                -2.09593159e00,
                2.63593130e00,
                2.30025211e-16,
                2.02149920e00,
            ],
            [
                4.01129721e00,
                -2.66143753e00,
                -2.56508936e00,
                1.55299389e-16,
                -1.77865328e-15,
                -5.85364139e-02,
                1.12554476e-15,
                1.23379885e-16,
                -5.80808378e-02,
                1.37555455e-29,
                -3.62489141e-18,
                -4.23700373e-03,
                -1.17351678e-15,
                -4.11967608e-02,
                -6.32424644e-01,
                -1.23678288e00,
                -1.16713199e00,
                -4.67616206e-16,
                8.81518590e-01,
                -6.32424644e-01,
                -1.23678288e00,
                1.16713199e00,
                -4.67616206e-16,
                8.81518590e-01,
            ],
            [
                -5.92887572e00,
                -2.56508936e00,
                -7.61474091e00,
                -4.42658277e-16,
                -1.21843277e-15,
                -1.20197431e-01,
                6.36107786e-16,
                1.21289005e-16,
                -2.39798016e-01,
                -1.03060856e-28,
                6.32990956e-17,
                -1.14715361e-02,
                -3.56511885e-15,
                -1.11536643e-01,
                -2.01627970e00,
                -4.20157893e00,
                -2.87977361e00,
                8.94096482e-16,
                2.15921765e00,
                -2.01627970e00,
                -4.20157893e00,
                2.87977361e00,
                8.94096482e-16,
                2.15921765e00,
            ],
            [
                -1.48134665e-17,
                1.55299389e-16,
                -4.42658277e-16,
                -4.03073447e00,
                1.59584021e-29,
                -2.30022285e-16,
                -2.63942606e00,
                1.89889884e-29,
                -1.41159902e-15,
                -2.53192879e-15,
                -3.43439615e-29,
                4.93058782e-16,
                -1.42720504e-01,
                5.59595327e-16,
                7.06205607e-01,
                4.50664973e-01,
                9.00682598e-01,
                -4.18998338e-16,
                -1.45476034e00,
                -7.06205607e-01,
                -4.50664973e-01,
                9.00682598e-01,
                4.18998338e-16,
                1.45476034e00,
            ],
            [
                6.62313701e-15,
                -1.77865328e-15,
                -1.21843277e-15,
                1.59584021e-29,
                -3.98116604e00,
                -2.87218805e-18,
                4.31650914e-30,
                -2.57319009e00,
                -4.29617587e-17,
                -2.48421042e-17,
                -8.35323245e-02,
                1.44518955e-15,
                9.19954849e-29,
                2.50728566e-15,
                3.70881251e-16,
                3.63541911e-16,
                9.91154996e-16,
                -1.00276569e00,
                -7.84598966e-16,
                3.70881251e-16,
                3.63541911e-16,
                -9.91154996e-16,
                -1.00276569e00,
                -7.84598966e-16,
            ],
            [
                -2.06875540e-02,
                -5.85364139e-02,
                -1.20197431e-01,
                -2.30022285e-16,
                -2.87218805e-18,
                -4.01036533e00,
                -1.19956375e-16,
                -4.24347003e-17,
                -2.61220769e00,
                -4.12823065e-29,
                -2.51402341e-15,
                -9.94985050e-02,
                -1.14080364e-15,
                -2.95945533e-02,
                -5.58315913e-01,
                -3.99215457e-01,
                -1.49983399e00,
                3.19682962e-16,
                1.31873026e-01,
                -5.58315913e-01,
                -3.99215457e-01,
                1.49983399e00,
                3.19682962e-16,
                1.31873026e-01,
            ],
            [
                -1.20642164e-15,
                1.12554476e-15,
                6.36107786e-16,
                -2.63942606e00,
                4.31650914e-30,
                -1.19956375e-16,
                -4.83113394e00,
                8.42489142e-30,
                -1.27735993e-16,
                1.44825299e-15,
                -3.23849972e-29,
                3.68615329e-16,
                -2.17741490e-01,
                -6.34368300e-16,
                1.48481705e00,
                1.34816728e00,
                1.12359295e-01,
                4.04405018e-18,
                -1.51072626e00,
                -1.48481705e00,
                -1.34816728e00,
                1.12359295e-01,
                -4.04405018e-18,
                1.51072626e00,
            ],
            [
                -9.10889830e-17,
                1.23379885e-16,
                1.21289005e-16,
                1.89889884e-29,
                -2.57319009e00,
                -4.24347003e-17,
                8.42489142e-30,
                -4.60429694e00,
                -8.87360135e-17,
                3.70261976e-16,
                -1.03054533e-01,
                -8.11614922e-16,
                4.44495937e-29,
                -1.35535849e-15,
                5.15663058e-17,
                5.67309660e-17,
                -4.32013090e-17,
                -1.88904615e00,
                -3.98134385e-17,
                5.15663058e-17,
                5.67309660e-17,
                4.32013090e-17,
                -1.88904615e00,
                -3.98134385e-17,
            ],
            [
                -5.64010193e-03,
                -5.80808378e-02,
                -2.39798016e-01,
                -1.41159902e-15,
                -4.29617587e-17,
                -2.61220769e00,
                -1.27735993e-16,
                -8.87360135e-17,
                -4.73791979e00,
                -6.61499793e-29,
                1.44290551e-15,
                -1.24895192e-01,
                -8.29701562e-16,
                -5.73432420e-02,
                -1.17062060e00,
                -1.18590271e00,
                -1.58899369e00,
                -3.30854644e-17,
                -7.16887321e-01,
                -1.17062060e00,
                -1.18590271e00,
                1.58899369e00,
                -3.30854644e-17,
                -7.16887321e-01,
            ],
            [
                -1.72295788e-28,
                1.37555455e-29,
                -1.03060856e-28,
                -2.53192879e-15,
                -2.48421042e-17,
                -4.12823065e-29,
                1.44825299e-15,
                3.70261976e-16,
                -6.61499793e-29,
                -4.32742740e00,
                -2.16521426e-16,
                -9.06694623e-30,
                1.20985248e-16,
                1.32395790e-29,
                -7.79441590e-17,
                2.58864754e-16,
                -1.82918672e-17,
                1.32533740e00,
                -2.47567186e-17,
                7.79441590e-17,
                -2.58864754e-16,
                -1.82918672e-17,
                -1.32533740e00,
                2.47567186e-17,
            ],
            [
                8.64568564e-19,
                -3.62489141e-18,
                6.32990956e-17,
                -3.43439615e-29,
                -8.35323245e-02,
                -2.51402341e-15,
                -3.23849972e-29,
                -1.03054533e-01,
                1.44290551e-15,
                -2.16521426e-16,
                -4.29034397e00,
                6.54617767e-17,
                -4.38772839e-29,
                -5.34373878e-17,
                6.20549282e-17,
                -2.27669518e-16,
                3.01118693e-17,
                -1.04039218e00,
                4.26453078e-17,
                6.20549282e-17,
                -2.27669518e-16,
                -3.01118693e-17,
                -1.04039218e00,
                4.26453078e-17,
            ],
            [
                -3.41894315e-04,
                -4.23700373e-03,
                -1.14715361e-02,
                4.93058782e-16,
                1.44518955e-15,
                -9.94985050e-02,
                3.68615329e-16,
                -8.11614922e-16,
                -1.24895192e-01,
                -9.06694623e-30,
                6.54617767e-17,
                -4.33860180e00,
                1.12227171e-15,
                4.76798667e-02,
                -6.32878660e-02,
                -3.04871696e-02,
                -9.38588560e-01,
                1.54522498e-18,
                -1.08339074e00,
                -6.32878660e-02,
                -3.04871696e-02,
                9.38588560e-01,
                1.54522498e-18,
                -1.08339074e00,
            ],
            [
                -3.44427071e-15,
                -1.17351678e-15,
                -3.56511885e-15,
                -1.42720504e-01,
                9.19954849e-29,
                -1.14080364e-15,
                -2.17741490e-01,
                4.44495937e-29,
                -8.29701562e-16,
                1.20985248e-16,
                -4.38772839e-29,
                1.12227171e-15,
                -4.48183166e00,
                1.07046424e-15,
                7.07903302e-01,
                1.63794014e-01,
                7.95440099e-01,
                -2.56506043e-17,
                -7.50816122e-02,
                -7.07903302e-01,
                -1.63794014e-01,
                7.95440099e-01,
                2.56506043e-17,
                7.50816122e-02,
            ],
            [
                -3.32408521e-03,
                -4.11967608e-02,
                -1.11536643e-01,
                5.59595327e-16,
                2.50728566e-15,
                -2.95945533e-02,
                -6.34368300e-16,
                -1.35535849e-15,
                -5.73432420e-02,
                1.32395790e-29,
                -5.34373878e-17,
                4.76798667e-02,
                1.07046424e-15,
                -4.37039944e00,
                -4.61190582e-01,
                -1.47664850e-01,
                1.41067259e-01,
                1.75106733e-17,
                9.02518529e-01,
                -4.61190582e-01,
                -1.47664850e-01,
                -1.41067259e-01,
                1.75106733e-17,
                9.02518529e-01,
            ],
            [
                -9.37574577e-01,
                -6.32424644e-01,
                -2.01627970e00,
                7.06205607e-01,
                3.70881251e-16,
                -5.58315913e-01,
                1.48481705e00,
                5.15663058e-17,
                -1.17062060e00,
                -7.79441590e-17,
                6.20549282e-17,
                -6.32878660e-02,
                7.07903302e-01,
                -4.61190582e-01,
                -1.76338263e00,
                -2.08926954e00,
                -7.20138678e-01,
                9.34917195e-16,
                5.18678781e-01,
                -3.14047451e-01,
                -1.09090215e00,
                7.35537444e-01,
                1.39339458e-16,
                1.21187851e-01,
            ],
            [
                -2.09593159e00,
                -1.23678288e00,
                -4.20157893e00,
                4.50664973e-01,
                3.63541911e-16,
                -3.99215457e-01,
                1.34816728e00,
                5.67309660e-17,
                -1.18590271e00,
                2.58864754e-16,
                -2.27669518e-16,
                -3.04871696e-02,
                1.63794014e-01,
                -1.47664850e-01,
                -2.08926954e00,
                -4.20653655e00,
                -1.05291289e00,
                1.91399382e-15,
                7.53927481e-01,
                -1.09090215e00,
                -2.93590290e00,
                1.47076654e00,
                9.27092972e-16,
                4.59653796e-01,
            ],
            [
                -2.63593130e00,
                -1.16713199e00,
                -2.87977361e00,
                9.00682598e-01,
                9.91154996e-16,
                -1.49983399e00,
                1.12359295e-01,
                -4.32013090e-17,
                -1.58899369e00,
                -1.82918672e-17,
                3.01118693e-17,
                -9.38588560e-01,
                7.95440099e-01,
                1.41067259e-01,
                -7.20138678e-01,
                -1.05291289e00,
                -4.19336028e00,
                1.40198867e-17,
                6.04324603e-01,
                -7.35537444e-01,
                -1.47076654e00,
                1.93070745e00,
                -4.43315303e-17,
                3.12811843e-01,
            ],
            [
                2.30025211e-16,
                -4.67616206e-16,
                8.94096482e-16,
                -4.18998338e-16,
                -1.00276569e00,
                3.19682962e-16,
                4.04405018e-18,
                -1.88904615e00,
                -3.30854644e-17,
                1.32533740e00,
                -1.04039218e00,
                1.54522498e-18,
                -2.56506043e-17,
                1.75106733e-17,
                9.34917195e-16,
                1.91399382e-15,
                1.40198867e-17,
                -3.36311540e00,
                3.15367026e-17,
                1.39339458e-16,
                9.27092972e-16,
                4.43315303e-17,
                -3.35882760e-01,
                -6.38222253e-17,
            ],
            [
                2.02149920e00,
                8.81518590e-01,
                2.15921765e00,
                -1.45476034e00,
                -7.84598966e-16,
                1.31873026e-01,
                -1.51072626e00,
                -3.98134385e-17,
                -7.16887321e-01,
                -2.47567186e-17,
                4.26453078e-17,
                -1.08339074e00,
                -7.50816122e-02,
                9.02518529e-01,
                5.18678781e-01,
                7.53927481e-01,
                6.04324603e-01,
                3.15367026e-17,
                -3.82694045e00,
                1.21187851e-01,
                4.59653796e-01,
                -3.12811843e-01,
                -6.38222253e-17,
                -4.49382446e-01,
            ],
            [
                -9.37574577e-01,
                -6.32424644e-01,
                -2.01627970e00,
                -7.06205607e-01,
                3.70881251e-16,
                -5.58315913e-01,
                -1.48481705e00,
                5.15663058e-17,
                -1.17062060e00,
                7.79441590e-17,
                6.20549282e-17,
                -6.32878660e-02,
                -7.07903302e-01,
                -4.61190582e-01,
                -3.14047451e-01,
                -1.09090215e00,
                -7.35537444e-01,
                1.39339458e-16,
                1.21187851e-01,
                -1.76338263e00,
                -2.08926954e00,
                7.20138678e-01,
                9.34917195e-16,
                5.18678781e-01,
            ],
            [
                -2.09593159e00,
                -1.23678288e00,
                -4.20157893e00,
                -4.50664973e-01,
                3.63541911e-16,
                -3.99215457e-01,
                -1.34816728e00,
                5.67309660e-17,
                -1.18590271e00,
                -2.58864754e-16,
                -2.27669518e-16,
                -3.04871696e-02,
                -1.63794014e-01,
                -1.47664850e-01,
                -1.09090215e00,
                -2.93590290e00,
                -1.47076654e00,
                9.27092972e-16,
                4.59653796e-01,
                -2.08926954e00,
                -4.20653655e00,
                1.05291289e00,
                1.91399382e-15,
                7.53927481e-01,
            ],
            [
                2.63593130e00,
                1.16713199e00,
                2.87977361e00,
                9.00682598e-01,
                -9.91154996e-16,
                1.49983399e00,
                1.12359295e-01,
                4.32013090e-17,
                1.58899369e00,
                -1.82918672e-17,
                -3.01118693e-17,
                9.38588560e-01,
                7.95440099e-01,
                -1.41067259e-01,
                7.35537444e-01,
                1.47076654e00,
                1.93070745e00,
                4.43315303e-17,
                -3.12811843e-01,
                7.20138678e-01,
                1.05291289e00,
                -4.19336028e00,
                -1.40198867e-17,
                -6.04324603e-01,
            ],
            [
                2.30025211e-16,
                -4.67616206e-16,
                8.94096482e-16,
                4.18998338e-16,
                -1.00276569e00,
                3.19682962e-16,
                -4.04405018e-18,
                -1.88904615e00,
                -3.30854644e-17,
                -1.32533740e00,
                -1.04039218e00,
                1.54522498e-18,
                2.56506043e-17,
                1.75106733e-17,
                1.39339458e-16,
                9.27092972e-16,
                -4.43315303e-17,
                -3.35882760e-01,
                -6.38222253e-17,
                9.34917195e-16,
                1.91399382e-15,
                -1.40198867e-17,
                -3.36311540e00,
                3.15367026e-17,
            ],
            [
                2.02149920e00,
                8.81518590e-01,
                2.15921765e00,
                1.45476034e00,
                -7.84598966e-16,
                1.31873026e-01,
                1.51072626e00,
                -3.98134385e-17,
                -7.16887321e-01,
                2.47567186e-17,
                4.26453078e-17,
                -1.08339074e00,
                7.50816122e-02,
                9.02518529e-01,
                1.21187851e-01,
                4.59653796e-01,
                3.12811843e-01,
                -6.38222253e-17,
                -4.49382446e-01,
                5.18678781e-01,
                7.53927481e-01,
                -6.04324603e-01,
                3.15367026e-17,
                -3.82694045e00,
            ],
        ],
        dtype=np.double,
    )
    fn = context.get_fn("test/h2o_ccdz.xyz")
    obs = get_gobasis("cc-pvdz", fn, print_basis=False)

    return 24, smallref_array, obs, 1e-05, 1e-08


def dkhn_u2_reference_data() -> (
    tuple[int, np.ndarray[Any, Any], Basis, float, float]
):
    """Reference integral data for dkh2 u2 test

    Returns:
        tuple:
            int: integral matrix size
            np.ndarray: integral matrix
            Basis: basis instance
            np.double: relative tolerance
            np.double: absolute tolerance
    """
    fnints = context.get_fn("test/ints_u2_dkh.txt")
    largeref_array = np.fromfile(fnints, sep=",", dtype=np.double).reshape(
        428, 428
    )

    fn = context.get_fn("test/u2.xyz")
    obs = get_gobasis("ano-rcc", fn, print_basis=False)

    return 428, largeref_array, obs, 1e-05, 2e-07


def x2c_h2o_reference_data() -> (
    tuple[int, np.ndarray[Any, Any], Basis, float, float]
):
    """Reference integral data for x2c h2o test

    Returns:
        tuple:
            int: integral matrix size
            np.ndarray: integral matrix
            Basis: basis instance
            np.double: relative tolerance
            np.double: absolute tolerance
    """
    fnints = context.get_fn("test/ints_h2o_x2c.txt")
    smallref_array = np.fromfile(fnints, sep=",", dtype=np.double).reshape(
        24, 24
    )

    fn = context.get_fn("test/h2o_ccdz.xyz")
    obs = get_gobasis("cc-pvdz", fn, print_basis=False)

    return 24, smallref_array, obs, 1e-05, 1e-08


def x2c_u2_reference_data() -> (
    tuple[int, np.ndarray[Any, Any], Basis, float, float]
):
    """Reference integral data for x2c u2 test

    Returns:
        tuple:
            int: integral matrix size
            np.ndarray: integral matrix
            Basis: basis instance
            np.double: relative tolerance
            np.double: absolute tolerance
    """
    fnints = context.get_fn("test/ints_u2_x2c.txt")
    largeref_array = np.fromfile(fnints, sep=",", dtype=np.double).reshape(
        150, 150
    )

    fn = context.get_fn("test/u2.xyz")
    obs = get_gobasis("ano-rcc-vdz", fn, print_basis=False)
    return 150, largeref_array, obs, 1e-05, 2e-07


dkhn_reference_data = [dkhn_h2o_reference_data, dkhn_u2_reference_data]
x2c_reference_data = [x2c_h2o_reference_data, x2c_u2_reference_data]


@pytest.fixture(params=dkhn_reference_data)
def dkhn_refs(request):
    return request.param()


@pytest.fixture(params=x2c_reference_data)
def x2c_refs(request):
    return request.param()
