# PyBEST: Pythonic Black-box Electronic Structure Tool
# Copyright (C) 2016-- The PyBEST Development Team
#
# This file is part of PyBEST.
#
# PyBEST is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 3
# of the License, or (at your option) any later version.
#
# PyBEST is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, see <http://www.gnu.org/licenses/>
# --

import numpy as np
import pytest

from pybest.orbital_entanglement.orbital_entanglement import (
    OrbitalEntanglementRpCCD,
)
from pybest.orbital_entanglement.tests.common import Molecule

s1_ref = np.array(
    [
        7.82013822e-05,
        8.49536133e-05,
        1.66407137e-02,
        1.29918128e-01,
        1.29918128e-01,
        5.23694985e-01,
        5.21122532e-01,
        1.25261693e-01,
        1.25261693e-01,
        1.00092892e-02,
        1.00092892e-02,
        8.18635915e-03,
        6.56871613e-03,
        6.56871613e-03,
        6.13583842e-03,
        1.80963925e-03,
        1.80963925e-03,
        1.24440110e-03,
        9.02828404e-04,
        9.02828404e-04,
        8.25568835e-04,
        8.25568835e-04,
        7.96813929e-04,
        2.48926269e-04,
        1.48055932e-04,
        1.48055932e-04,
        1.41679691e-04,
        2.51527575e-05,
    ]
)

mi_ref = np.array(
    [
        [
            0.00000000e00,
            8.67109206e-06,
            2.14587855e-05,
            5.36660948e-06,
            5.36660948e-06,
            1.98993068e-06,
            1.63552655e-06,
            5.43651909e-06,
            5.43651909e-06,
            1.10753270e-06,
            1.10753270e-06,
            6.96483048e-05,
            6.49323679e-09,
            6.49323679e-09,
            9.95921069e-07,
            1.85583044e-06,
            1.85583044e-06,
            1.01807667e-05,
            5.04618744e-10,
            5.04618745e-10,
            4.21138861e-06,
            4.21138861e-06,
            6.37477497e-06,
            3.26234906e-06,
            2.28071174e-10,
            2.28071389e-10,
            3.27698785e-07,
            6.41785233e-07,
        ],
        [
            8.67109206e-06,
            0.00000000e00,
            2.27150033e-05,
            6.29528144e-06,
            6.29528143e-06,
            2.06359323e-06,
            1.70718976e-06,
            6.62099305e-06,
            6.62099305e-06,
            1.09876919e-06,
            1.09876919e-06,
            7.51097941e-05,
            6.21189103e-09,
            6.21189104e-09,
            9.53736985e-07,
            1.80099778e-06,
            1.80099778e-06,
            1.11479829e-05,
            5.11139616e-10,
            5.11139617e-10,
            4.88530488e-06,
            4.88530488e-06,
            5.92452947e-06,
            3.76557804e-06,
            4.88055337e-10,
            4.88055606e-10,
            3.15268221e-07,
            7.29260163e-07,
        ],
        [
            2.14587855e-05,
            2.27150033e-05,
            0.00000000e00,
            7.13095616e-04,
            7.13095616e-04,
            2.15507843e-03,
            2.69090413e-03,
            8.77238279e-04,
            8.77238279e-04,
            2.05689693e-03,
            2.05689693e-03,
            1.28277562e-02,
            7.92978804e-04,
            7.92978804e-04,
            5.91920131e-03,
            3.77516668e-04,
            3.77516668e-04,
            3.84498255e-06,
            1.19115305e-04,
            1.19115305e-04,
            1.38416599e-04,
            1.38416599e-04,
            6.16817188e-05,
            7.70206758e-05,
            1.40332918e-05,
            1.40332918e-05,
            6.79991652e-05,
            1.37130319e-06,
        ],
        [
            5.36660948e-06,
            6.29528144e-06,
            7.13095616e-04,
            0.00000000e00,
            1.21288038e-03,
            7.03346397e-03,
            7.14143020e-03,
            2.26257113e-01,
            1.02220247e-03,
            1.24689576e-02,
            7.99878185e-05,
            5.24323730e-04,
            4.06615407e-03,
            4.06615408e-03,
            1.70451544e-03,
            1.88446491e-03,
            4.52371328e-05,
            7.72078024e-05,
            4.46042445e-04,
            4.46042446e-04,
            1.16092638e-05,
            8.57790958e-04,
            1.94518447e-04,
            6.94088443e-05,
            3.15082955e-06,
            1.05673432e-04,
            4.61551196e-05,
            6.47360210e-06,
        ],
        [
            5.36660948e-06,
            6.29528143e-06,
            7.13095616e-04,
            1.21288038e-03,
            0.00000000e00,
            7.03346397e-03,
            7.14143020e-03,
            1.02220247e-03,
            2.26257113e-01,
            7.99878185e-05,
            1.24689576e-02,
            5.24323730e-04,
            4.06615407e-03,
            4.06615407e-03,
            1.70451546e-03,
            4.52371328e-05,
            1.88446491e-03,
            7.72078024e-05,
            4.46042448e-04,
            4.46042446e-04,
            8.57790958e-04,
            1.16092638e-05,
            1.94518447e-04,
            6.94088431e-05,
            1.05673432e-04,
            3.15082955e-06,
            4.61551196e-05,
            6.47360210e-06,
        ],
        [
            1.98993068e-06,
            2.06359323e-06,
            2.15507843e-03,
            7.03346397e-03,
            7.03346397e-03,
            0.00000000e00,
            1.01947279e00,
            1.16728538e-02,
            1.16728538e-02,
            3.24961347e-04,
            3.24961347e-04,
            3.44295791e-04,
            2.49031421e-04,
            2.49031421e-04,
            2.25811908e-04,
            1.53470332e-04,
            1.53470332e-04,
            1.22642440e-03,
            1.40508528e-04,
            1.40508528e-04,
            7.92547175e-05,
            7.92547176e-05,
            4.72631163e-04,
            8.55078308e-05,
            5.37770173e-05,
            5.37770173e-05,
            2.09179457e-05,
            1.31409977e-05,
        ],
        [
            1.63552655e-06,
            1.70718976e-06,
            2.69090413e-03,
            7.14143020e-03,
            7.14143020e-03,
            1.01947279e00,
            0.00000000e00,
            8.78003894e-03,
            8.78003894e-03,
            3.27477567e-04,
            3.27477567e-04,
            2.97893614e-04,
            2.06376003e-04,
            2.06376003e-04,
            2.14474046e-04,
            1.10616467e-04,
            1.10616467e-04,
            9.09779998e-04,
            9.55254318e-05,
            9.55254318e-05,
            5.70818384e-05,
            5.70818384e-05,
            3.43796252e-04,
            6.43578533e-05,
            4.03631405e-05,
            4.03631405e-05,
            1.58589814e-05,
            1.01501258e-05,
        ],
        [
            5.43651909e-06,
            6.62099305e-06,
            8.77238279e-04,
            2.26257113e-01,
            1.02220247e-03,
            1.16728538e-02,
            8.78003894e-03,
            0.00000000e00,
            1.12186524e-03,
            4.30453803e-03,
            7.98031850e-05,
            2.42717228e-04,
            1.65287921e-03,
            1.65287921e-03,
            6.89787521e-04,
            9.61144016e-04,
            5.61811481e-05,
            1.26355158e-04,
            2.80290062e-04,
            2.80290063e-04,
            2.07733145e-05,
            4.75101932e-04,
            1.77826001e-04,
            6.19108879e-05,
            7.98821723e-06,
            7.81755539e-05,
            3.66226228e-05,
            6.98529757e-06,
        ],
        [
            5.43651909e-06,
            6.62099305e-06,
            8.77238279e-04,
            1.02220247e-03,
            2.26257113e-01,
            1.16728538e-02,
            8.78003894e-03,
            1.12186524e-03,
            0.00000000e00,
            7.98031850e-05,
            4.30453803e-03,
            2.42717228e-04,
            1.65287920e-03,
            1.65287920e-03,
            6.89787526e-04,
            5.61811481e-05,
            9.61144016e-04,
            1.26355158e-04,
            2.80290064e-04,
            2.80290063e-04,
            4.75101932e-04,
            2.07733145e-05,
            1.77826001e-04,
            6.19108871e-05,
            7.81755539e-05,
            7.98821723e-06,
            3.66226228e-05,
            6.98529758e-06,
        ],
        [
            1.10753270e-06,
            1.09876919e-06,
            2.05689693e-03,
            1.24689576e-02,
            7.99878185e-05,
            3.24961347e-04,
            3.27477567e-04,
            4.30453803e-03,
            7.98031850e-05,
            0.00000000e00,
            7.05571578e-05,
            3.66888065e-04,
            6.75238169e-04,
            6.75238169e-04,
            5.63053971e-04,
            4.94688845e-04,
            3.88029186e-05,
            1.51758064e-05,
            1.41037605e-04,
            1.41037606e-04,
            1.53304973e-05,
            2.61151792e-04,
            6.03815495e-05,
            3.63500470e-05,
            3.32037390e-06,
            3.92300178e-05,
            2.92146101e-05,
            3.22446685e-06,
        ],
        [
            1.10753270e-06,
            1.09876919e-06,
            2.05689693e-03,
            7.99878185e-05,
            1.24689576e-02,
            3.24961347e-04,
            3.27477567e-04,
            7.98031850e-05,
            4.30453803e-03,
            7.05571578e-05,
            0.00000000e00,
            3.66888065e-04,
            6.75238168e-04,
            6.75238168e-04,
            5.63053974e-04,
            3.88029186e-05,
            4.94688845e-04,
            1.51758064e-05,
            1.41037606e-04,
            1.41037606e-04,
            2.61151792e-04,
            1.53304973e-05,
            6.03815495e-05,
            3.63500465e-05,
            3.92300178e-05,
            3.32037390e-06,
            2.92146101e-05,
            3.22446685e-06,
        ],
        [
            6.96483048e-05,
            7.51097941e-05,
            1.28277562e-02,
            5.24323730e-04,
            5.24323730e-04,
            3.44295791e-04,
            2.97893614e-04,
            2.42717228e-04,
            2.42717228e-04,
            3.66888065e-04,
            3.66888065e-04,
            0.00000000e00,
            2.77673944e-04,
            2.77673944e-04,
            9.26844540e-04,
            1.21180130e-04,
            1.21180130e-04,
            5.10970557e-07,
            6.30287908e-05,
            6.30287908e-05,
            5.82670555e-05,
            5.82670555e-05,
            2.35531965e-05,
            3.04512929e-05,
            7.50718059e-06,
            7.50718059e-06,
            2.99955029e-05,
            1.19974808e-06,
        ],
        [
            6.49323679e-09,
            6.21189103e-09,
            7.92978804e-04,
            4.06615407e-03,
            4.06615407e-03,
            2.49031421e-04,
            2.06376003e-04,
            1.65287921e-03,
            1.65287920e-03,
            6.75238169e-04,
            6.75238168e-04,
            2.77673944e-04,
            0.00000000e00,
            1.12220551e-03,
            6.01878510e-04,
            2.71765168e-04,
            2.71765168e-04,
            4.43193713e-05,
            2.48997439e-04,
            2.48997439e-04,
            1.41229302e-04,
            1.41229302e-04,
            1.15157769e-04,
            5.95744186e-05,
            2.88990091e-05,
            2.88990091e-05,
            4.42404657e-05,
            6.44693729e-06,
        ],
        [
            6.49323679e-09,
            6.21189104e-09,
            7.92978804e-04,
            4.06615408e-03,
            4.06615407e-03,
            2.49031421e-04,
            2.06376003e-04,
            1.65287921e-03,
            1.65287920e-03,
            6.75238169e-04,
            6.75238168e-04,
            2.77673944e-04,
            1.12220551e-03,
            0.00000000e00,
            6.01878510e-04,
            2.71765168e-04,
            2.71765168e-04,
            4.43193713e-05,
            2.48997439e-04,
            2.48997439e-04,
            1.41229302e-04,
            1.41229302e-04,
            1.15157769e-04,
            5.95744186e-05,
            2.88990091e-05,
            2.88990091e-05,
            4.42404657e-05,
            6.44693729e-06,
        ],
        [
            9.95921069e-07,
            9.53736985e-07,
            5.91920131e-03,
            1.70451544e-03,
            1.70451546e-03,
            2.25811908e-04,
            2.14474046e-04,
            6.89787521e-04,
            6.89787526e-04,
            5.63053971e-04,
            5.63053974e-04,
            9.26844540e-04,
            6.01878510e-04,
            6.01878510e-04,
            0.00000000e00,
            2.01920970e-04,
            2.01920971e-04,
            6.33765698e-06,
            1.37741844e-04,
            1.37741844e-04,
            1.00711710e-04,
            1.00711709e-04,
            5.29972248e-05,
            4.60013699e-05,
            1.59067890e-05,
            1.59067890e-05,
            4.25700733e-05,
            2.94647422e-06,
        ],
        [
            1.85583044e-06,
            1.80099778e-06,
            3.77516668e-04,
            1.88446491e-03,
            4.52371328e-05,
            1.53470332e-04,
            1.10616467e-04,
            9.61144016e-04,
            5.61811481e-05,
            4.94688845e-04,
            3.88029186e-05,
            1.21180130e-04,
            2.71765168e-04,
            2.71765168e-04,
            2.01920970e-04,
            0.00000000e00,
            3.63536645e-05,
            3.55315211e-05,
            1.01816740e-04,
            1.01816740e-04,
            1.90158980e-05,
            1.60393315e-04,
            6.60034504e-05,
            3.73458036e-05,
            7.38826575e-06,
            3.63074785e-05,
            2.65041735e-05,
            4.67125268e-06,
        ],
        [
            1.85583044e-06,
            1.80099778e-06,
            3.77516668e-04,
            4.52371328e-05,
            1.88446491e-03,
            1.53470332e-04,
            1.10616467e-04,
            5.61811481e-05,
            9.61144016e-04,
            3.88029186e-05,
            4.94688845e-04,
            1.21180130e-04,
            2.71765168e-04,
            2.71765168e-04,
            2.01920971e-04,
            3.63536645e-05,
            0.00000000e00,
            3.55315211e-05,
            1.01816740e-04,
            1.01816740e-04,
            1.60393315e-04,
            1.90158980e-05,
            6.60034504e-05,
            3.73458032e-05,
            3.63074785e-05,
            7.38826575e-06,
            2.65041735e-05,
            4.67125269e-06,
        ],
        [
            1.01807667e-05,
            1.11479829e-05,
            3.84498255e-06,
            7.72078024e-05,
            7.72078024e-05,
            1.22642440e-03,
            9.09779998e-04,
            1.26355158e-04,
            1.26355158e-04,
            1.51758064e-05,
            1.51758064e-05,
            5.10970557e-07,
            4.43193713e-05,
            4.43193713e-05,
            6.33765698e-06,
            3.55315211e-05,
            3.55315211e-05,
            0.00000000e00,
            4.46475294e-05,
            4.46475294e-05,
            2.50937950e-05,
            2.50937950e-05,
            9.89899965e-05,
            3.02447185e-05,
            1.96685725e-05,
            1.96685725e-05,
            1.11876906e-05,
            6.88662795e-06,
        ],
        [
            5.04618744e-10,
            5.11139616e-10,
            1.19115305e-04,
            4.46042445e-04,
            4.46042448e-04,
            1.40508528e-04,
            9.55254318e-05,
            2.80290062e-04,
            2.80290064e-04,
            1.41037605e-04,
            1.41037606e-04,
            6.30287908e-05,
            2.48997439e-04,
            2.48997439e-04,
            1.37741844e-04,
            1.01816740e-04,
            1.01816740e-04,
            4.46475294e-05,
            0.00000000e00,
            1.20973627e-04,
            6.41053161e-05,
            6.41053158e-05,
            7.78750869e-05,
            4.31349539e-05,
            2.26146873e-05,
            2.26146872e-05,
            2.95905491e-05,
            6.44350829e-06,
        ],
        [
            5.04618745e-10,
            5.11139617e-10,
            1.19115305e-04,
            4.46042446e-04,
            4.46042446e-04,
            1.40508528e-04,
            9.55254318e-05,
            2.80290063e-04,
            2.80290063e-04,
            1.41037606e-04,
            1.41037606e-04,
            6.30287908e-05,
            2.48997439e-04,
            2.48997439e-04,
            1.37741844e-04,
            1.01816740e-04,
            1.01816740e-04,
            4.46475294e-05,
            1.20973627e-04,
            0.00000000e00,
            6.41053159e-05,
            6.41053159e-05,
            7.78750869e-05,
            4.31349539e-05,
            2.26146873e-05,
            2.26146873e-05,
            2.95905491e-05,
            6.44350829e-06,
        ],
        [
            4.21138861e-06,
            4.88530488e-06,
            1.38416599e-04,
            1.16092638e-05,
            8.57790958e-04,
            7.92547175e-05,
            5.70818384e-05,
            2.07733145e-05,
            4.75101932e-04,
            1.53304973e-05,
            2.61151792e-04,
            5.82670555e-05,
            1.41229302e-04,
            1.41229302e-04,
            1.00711710e-04,
            1.90158980e-05,
            1.60393315e-04,
            2.50937950e-05,
            6.41053161e-05,
            6.41053159e-05,
            0.00000000e00,
            1.06191926e-05,
            4.46936862e-05,
            2.68375642e-05,
            2.86869360e-05,
            5.09056004e-06,
            1.90687797e-05,
            3.95477395e-06,
        ],
        [
            4.21138861e-06,
            4.88530488e-06,
            1.38416599e-04,
            8.57790958e-04,
            1.16092638e-05,
            7.92547176e-05,
            5.70818384e-05,
            4.75101932e-04,
            2.07733145e-05,
            2.61151792e-04,
            1.53304973e-05,
            5.82670555e-05,
            1.41229302e-04,
            1.41229302e-04,
            1.00711709e-04,
            1.60393315e-04,
            1.90158980e-05,
            2.50937950e-05,
            6.41053158e-05,
            6.41053159e-05,
            1.06191926e-05,
            0.00000000e00,
            4.46936862e-05,
            2.68375644e-05,
            5.09056004e-06,
            2.86869360e-05,
            1.90687797e-05,
            3.95477395e-06,
        ],
        [
            6.37477497e-06,
            5.92452947e-06,
            6.16817188e-05,
            1.94518447e-04,
            1.94518447e-04,
            4.72631163e-04,
            3.43796252e-04,
            1.77826001e-04,
            1.77826001e-04,
            6.03815495e-05,
            6.03815495e-05,
            2.35531965e-05,
            1.15157769e-04,
            1.15157769e-04,
            5.29972248e-05,
            6.60034504e-05,
            6.60034504e-05,
            9.89899965e-05,
            7.78750869e-05,
            7.78750869e-05,
            4.46936862e-05,
            4.46936862e-05,
            0.00000000e00,
            4.31704748e-05,
            2.42148691e-05,
            2.42148691e-05,
            2.17639438e-05,
            8.24666430e-06,
        ],
        [
            3.26234906e-06,
            3.76557804e-06,
            7.70206758e-05,
            6.94088443e-05,
            6.94088431e-05,
            8.55078308e-05,
            6.43578533e-05,
            6.19108879e-05,
            6.19108871e-05,
            3.63500470e-05,
            3.63500465e-05,
            3.04512929e-05,
            5.95744186e-05,
            5.95744186e-05,
            4.60013699e-05,
            3.73458036e-05,
            3.73458032e-05,
            3.02447185e-05,
            4.31349539e-05,
            4.31349539e-05,
            2.68375642e-05,
            2.68375644e-05,
            4.31704748e-05,
            0.00000000e00,
            1.42223618e-05,
            1.42223619e-05,
            1.86178057e-05,
            5.32825859e-06,
        ],
        [
            2.28071174e-10,
            4.88055337e-10,
            1.40332918e-05,
            3.15082955e-06,
            1.05673432e-04,
            5.37770173e-05,
            4.03631405e-05,
            7.98821723e-06,
            7.81755539e-05,
            3.32037390e-06,
            3.92300178e-05,
            7.50718059e-06,
            2.88990091e-05,
            2.88990091e-05,
            1.59067890e-05,
            7.38826575e-06,
            3.63074785e-05,
            1.96685725e-05,
            2.26146873e-05,
            2.26146873e-05,
            2.86869360e-05,
            5.09056004e-06,
            2.42148691e-05,
            1.42223618e-05,
            0.00000000e00,
            4.60315551e-06,
            9.04408736e-06,
            3.56628902e-06,
        ],
        [
            2.28071389e-10,
            4.88055606e-10,
            1.40332918e-05,
            1.05673432e-04,
            3.15082955e-06,
            5.37770173e-05,
            4.03631405e-05,
            7.81755539e-05,
            7.98821723e-06,
            3.92300178e-05,
            3.32037390e-06,
            7.50718059e-06,
            2.88990091e-05,
            2.88990091e-05,
            1.59067890e-05,
            3.63074785e-05,
            7.38826575e-06,
            1.96685725e-05,
            2.26146872e-05,
            2.26146873e-05,
            5.09056004e-06,
            2.86869360e-05,
            2.42148691e-05,
            1.42223619e-05,
            4.60315551e-06,
            0.00000000e00,
            9.04408736e-06,
            3.56628902e-06,
        ],
        [
            3.27698785e-07,
            3.15268221e-07,
            6.79991652e-05,
            4.61551196e-05,
            4.61551196e-05,
            2.09179457e-05,
            1.58589814e-05,
            3.66226228e-05,
            3.66226228e-05,
            2.92146101e-05,
            2.92146101e-05,
            2.99955029e-05,
            4.42404657e-05,
            4.42404657e-05,
            4.25700733e-05,
            2.65041735e-05,
            2.65041735e-05,
            1.11876906e-05,
            2.95905491e-05,
            2.95905491e-05,
            1.90687797e-05,
            1.90687797e-05,
            2.17639438e-05,
            1.86178057e-05,
            9.04408736e-06,
            9.04408736e-06,
            0.00000000e00,
            3.32937184e-06,
        ],
        [
            6.41785233e-07,
            7.29260163e-07,
            1.37130319e-06,
            6.47360210e-06,
            6.47360210e-06,
            1.31409977e-05,
            1.01501258e-05,
            6.98529757e-06,
            6.98529758e-06,
            3.22446685e-06,
            3.22446685e-06,
            1.19974808e-06,
            6.44693729e-06,
            6.44693729e-06,
            2.94647422e-06,
            4.67125268e-06,
            4.67125269e-06,
            6.88662795e-06,
            6.44350829e-06,
            6.44350829e-06,
            3.95477395e-06,
            3.95477395e-06,
            8.24666430e-06,
            5.32825859e-06,
            3.56628902e-06,
            3.56628902e-06,
            3.32937184e-06,
            0.00000000e00,
        ],
    ]
)


test_data = [
    # basis, mol, orbitals, ncore
    (
        "cc-pvdz",
        "test/c2-12.xyz",
        "test/c2_12_pccd.txt",
        0,
        {"s_1": s1_ref, "I_12": mi_ref},
    ),
    ("cc-pvdz", "test/c2-12.xyz", "test/c2_12_pccd.txt", 1, {}),
]


@pytest.mark.parametrize("basis,mol,orb,ncore,expected", test_data)
def test_pccd(basis, mol, orb, ncore, expected):
    """Test pCCD s_i and I_ij to reference values if available. Otherwise
    only a dry run is performed."""
    mol = Molecule(basis, mol, orb, ncore)
    # do pCCD
    mol.do_pccd()

    oe = OrbitalEntanglementRpCCD(mol.lf, mol.pccd)
    oe_ = oe()

    for key, value in expected.items():
        assert np.allclose(value, getattr(oe_, key).array, atol=1e-4)
