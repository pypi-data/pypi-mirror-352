 # Extending Cellsampler

Cellsampler is designed to be extensible, allowing you to add new image preprocessing methods and segmentation methods. To do so you will need to add new Python files in the appropriate directories.

Currently the only way to do this is to install the Cellsampler package in editable mode, so that you can test your changes without having to reinstall the package every time. You can do this by cloning this repository and running the following command in the root directory of the Cellsampler repository:

```bash
pip install -e .
```

## Adding new image preprocessing methods

To add a new image preprocessing method, you need to add a new Python file in the `cellsampler/preprocessing` directory. The new file should contain a function named `run` that takes an image and optional keyword arguments and returns a preprocessed image. 

As an example of a preprocessing method, you can look at the `cellsampler/preprocessing/equalize_adapthist.py` file that contains the function to perform adaptive histogram equalization.


```python
from skimage import exposure


def run(image, kernel_size=(50, 50), clip_limit=0.02, nbins=256):
    """Run adaptive histogram equalization on an image

    Parameters
    ----------
    image : array
        image array

    Returns
    -------
    array
        equalized image array
    """

    return exposure.equalize_adapthist(
        image, kernel_size=kernel_size, clip_limit=clip_limit, nbins=nbins
    )
```


## Adding new segmentation methods
To add a new segmentation method, you need to add a new Python file in the `cellsampler/methods` directory. The new file should contain a function named `run` that takes an image and optional keyword arguments and returns a mask containing the segmented cells. The function should also be decorated with the `@preprocess_image` decorator to ensure that the image is preprocessed before segmentation.

For example to implement a new segmentation method, you can create a new file `cellsampler/methods/new_segmentation.py` with the following content:

```python
import numpy as np

from .utils import preprocess_image

@preprocess_image
def run(image: np.ndarray, kwarg1=None, kwarg2=None, **kwargs) -> np.ndarray:
    """
    Apply the new segmentation method to the image.

    Parameters:
    - image: np.ndarray - The input image to segment.
    - kwargs: Additional parameters for the segmentation method.

    Returns:
    - np.ndarray: The mask generated by the segmentation method.
    """
    # Implement the segmentation logic here
    pass
```


The new segmentation method can the be run in Python, with optional preprocessing steps, as follows:

```python
from cellsampler.methods.new_segmentation import run as new_segmentation

mask = new_segmentation(image, kwarg1=value1, kwarg2=value2,
                        preprocessing=["equalize_adapthist"],
                        equalize_adapthist={
                            "kernel_size": (50, 50),
                            "clip_limit": 0.02,
                            "nbins": 256
                        })"],

```

The `@preprocess_image` decorator will ensure that the image is preprocessed before being passed to the segmentation function. You can also add any additional keyword arguments that are specific to your segmentation method .

