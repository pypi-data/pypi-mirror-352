include:
  - project: "aimms/submodules/buildhelpers"
    ref: "feature/multi-python"
    file: "cmake/.aimms_build_matrix.yml"

build:
  stage: pipeline
  extends: .matrix_windows_only
  script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
    - python3 buildhelpers/cmake/buildCmake.py --login
    - python3 buildhelpers/cmake/buildCmake.py --check
    - python3 buildhelpers/cmake/buildCmake.py --multi --build
  artifacts:
    paths:
      - out/install
    reports:
      junit:
        - out/gtest.xml
        - out/cppunit.xml

# This step downloads all artifacts per job, which cannot be avoided with the current GitLab version.
# Namely we cannot specify the specific artifact, because dependencies does not allow environment variables and gitlab matrix doesn't support this.
upload:
  stage: pipeline
  extends: .matrix_windows_only
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_COMMIT_BRANCH == 'master' || $CI_COMMIT_BRANCH == 'main'
      when: always
    - when: manual
  script:
    - git config --global --add safe.directory $CI_PROJECT_DIR
    - python3 buildhelpers/cmake/buildCmake.py --login
    - python3 buildhelpers/cmake/buildCmake.py --multi --package
