"use strict";(self.webpackChunkjupyterlab_chat_extension=self.webpackChunkjupyterlab_chat_extension||[]).push([[515],{5515:(e,t,a)=>{a.r(t),a.d(t,{default:()=>E});var n=a(521),o=a(9674),r=a(9922),i=a(3549),c=a(9560),s=a(1689),d=a(6313),l=a(8607),h=a(2088),m=a(1767),u=a(1542),g=a(4918),p=a(484),y=a(7262),C=a(7053);const v={id:"jupyterlab-chat-extension:chatCommandRegistry",description:"The chat command registry used by the jupyterlab-chat-extension.",autoStart:!0,provides:o.IChatCommandRegistry,activate:e=>new o.ChatCommandRegistry};class f{constructor(){this.id="jupyter-chat:emoji-commands",this._slash_commands=[{name:":heart:",replaceWith:"❤ ",providerId:this.id,description:"Emoji",icon:"❤"},{name:":smile:",replaceWith:"🙂 ",providerId:this.id,description:"Emoji",icon:"🙂"},{name:":thinking:",replaceWith:"🤔 ",providerId:this.id,description:"Emoji",icon:"🤔"},{name:":cool:",replaceWith:"😎 ",providerId:this.id,description:"Emoji",icon:"😎"}],this._regex=/^:\w*:?/}async getChatCommands(e){var t,a;const n=null===(a=null===(t=e.currentWord)||void 0===t?void 0:t.match(this._regex))||void 0===a?void 0:a[0];return n?this._slash_commands.filter((e=>e.name.startsWith(n))):[]}async handleChatCommand(e,t){}}const I={id:"jupyterlab-chat-extension:emojiCommandsPlugin",description:"Plugin which adds emoji commands to the chat.",autoStart:!0,requires:[o.IChatCommandRegistry],activate:(e,t)=>{t.addProvider(new f)}};var w=a(3345),b=a.n(w);const T={id:"jupyterlab-chat-extension:mentionCommandsPlugin",description:"Plugin which adds user mention commands.",autoStart:!0,requires:[o.IChatCommandRegistry],activate:(e,t)=>{t.addProvider(new M)}};class M{constructor(){this.id="jupyter-chat:mention-commands",this._regex=/^@[\w-]*:?/,this._users=new Map}async getChatCommands(e){var t,a;this._users.clear();const n=null===(a=null===(t=e.currentWord)||void 0===t?void 0:t.match(this._regex))||void 0===a?void 0:a[0];return n?(e.chatContext.users.forEach((e=>{let t=e.mention_name;t||(t=R.getMentionName(e),e.mention_name=t),this._users.set(t,{user:e,icon:b().createElement(o.Avatar,{user:e})})})),Array.from(this._users).sort().filter((e=>e[0].toLowerCase().startsWith(n.toLowerCase()))).map((e=>({name:e[0],providerId:this.id,icon:e[1].icon})))):[]}async handleChatCommand(e,t){var a;t.replaceCurrentWord(`${e.name} `),this._users.has(e.name)&&(null===(a=t.addMention)||void 0===a||a.call(t,this._users.get(e.name).user))}}var R;!function(e){e.getMentionName=function(e){var t,a;return`@${(null!==(a=null!==(t=e.display_name)&&void 0!==t?t:e.name)&&void 0!==a?a:e.username).replace(/ /g,"-")}`}}(R||(R={}));const x="Chat",W="jupyterlab-chat-extension:factory",D={id:"jupyterlab-chat-extension:attachmentOpener",description:"The attachment opener registry.",autoStart:!0,provides:o.IAttachmentOpenerRegistry,activate:e=>{const t=new o.AttachmentOpenerRegistry;return t.set("file",(t=>{e.commands.execute("docmanager:open",{path:t.value})})),t}},F={id:W,description:"Document factories for chat.",autoStart:!0,requires:[m.IRenderMimeRegistry],optional:[C.IActiveCellManagerToken,o.IAttachmentOpenerRegistry,o.IChatCommandRegistry,r.ICollaborativeDrive,d.IDefaultFileBrowser,C.IInputToolbarRegistryFactory,i.ILayoutRestorer,o.IMessageFooterRegistry,C.ISelectionWatcherToken,u.ISettingRegistry,c.IThemeManager,c.IToolbarWidgetRegistry,g.ITranslator,C.IWelcomeMessage],provides:C.IChatFactory,activate:(e,t,a,n,r,i,s,d,l,h,m,u,p,v,f,I)=>{const w=null!=f?f:g.nullTranslator;let b;const T=new C.WidgetConfig({});function M(e){const t=T.config.defaultDirectory,a=e.get("defaultDirectory").composite;i&&t&&t!==a&&i.get(t).then((e=>{0===e.content.length&&i.delete(t).catch((e=>{}))})).catch((()=>{}));let n=Promise.resolve(null);i&&a&&t!==a&&(n=i.get(a,{content:!1}).catch((async()=>i.newUntitled({type:"directory"}).then((async e=>i.rename(e.path,a).catch((t=>{throw i.delete(e.path),new Error(t)})))).catch((e=>{throw new Error(e)}))))),n.then((()=>{T.config={sendWithShiftEnter:e.get("sendWithShiftEnter").composite,stackMessages:e.get("stackMessages").composite,unreadNotifications:e.get("unreadNotifications").composite,enableCodeToolbar:e.get("enableCodeToolbar").composite,sendTypingNotification:e.get("sendTypingNotification").composite,defaultDirectory:a}}))}u&&(v&&(b=(0,c.createToolbarFactory)(v,u,x,W,w)),Promise.all([e.restored,u.load(W)]).then((([,e])=>{M(e),e.changed.connect(M)})).catch((e=>{console.error(`Something went wrong when reading the settings.\n${e}`)})));const R=new c.WidgetTracker({namespace:"chat"});if(e.docRegistry.addFileType(C.chatFileType),i){const e=()=>C.YChat.create();i.sharedModelFactory.registerDocumentFactory("chat",e)}e.serviceManager.ready.then((()=>{const t=e.serviceManager.user.identity,n=new C.LabChatModelFactory({user:t,widgetConfig:T,commands:e.commands,activeCellManager:a,selectionWatcher:m,documentManager:null==s?void 0:s.model.manager});e.docRegistry.addModelFactory(n)})).catch((e=>console.error("The jupyterlab chat model factory is not initialized",e)));const D=new C.ChatWidgetFactory({name:x,label:"Chat",modelName:"chat",fileTypes:["chat"],defaultFor:["chat"],themeManager:p,rmRegistry:t,toolbarFactory:b,translator:w,chatCommandRegistry:r,attachmentOpenerRegistry:n,inputToolbarFactory:d,messageFooterRegistry:h,welcomeMessage:I});if(D.widgetCreated.connect(((t,a)=>{a.context.pathChanged.connect((()=>{R.save(a)})),R.add(a),a.model.unreadChanged.connect((()=>e.commands.notifyCommandChanged(C.CommandIDs.markAsRead)))})),e.docRegistry.addWidgetFactory(D),l){const t=new y.PromiseDelegate,a=()=>{e.commands.hasCommand(C.CommandIDs.openChat)&&(t.resolve(),e.commands.commandChanged.disconnect(a))};e.commands.commandChanged.connect(a),l.restore(R,{command:C.CommandIDs.openChat,args:e=>{var t;return{filepath:null!==(t=e.model.name)&&void 0!==t?t:"",inSidePanel:e instanceof o.ChatWidget}},name:e=>e.model.name,when:t.promise})}return{widgetConfig:T,tracker:R}}},j={id:"jupyterlab-chat-extension:commands",description:"The commands to create or open a chat.",autoStart:!0,requires:[r.ICollaborativeDrive,C.IChatFactory],optional:[C.IActiveCellManagerToken,C.IChatPanel,c.ICommandPalette,d.IDefaultFileBrowser,l.ILauncher,C.ISelectionWatcherToken],activate:(e,t,a,r,i,d,l,h,m)=>{const{commands:u}=e,{tracker:g,widgetConfig:p}=a;u.addCommand(C.CommandIDs.createChat,{label:e=>e.isPalette?"Create a new chat":"Chat",caption:"Create a chat",icon:e=>e.isPalette?void 0:o.chatIcon,execute:async e=>{var a,n;const o=null!==(a=e.inSidePanel)&&void 0!==a&&a;let r=null!==(n=e.name)&&void 0!==n?n:null,i="";if(r||(r=(await c.InputDialog.getText({label:"Name",placeholder:"untitled",title:"Create a new chat"})).value),null===r)return;r&&(i=r.endsWith(C.chatFileType.extensions[0])?r:`${r}${C.chatFileType.extensions[0]}`,i=s.PathExt.join(p.config.defaultDirectory||"",i));let d=!0;if(i?await t.get(i,{content:!1}).catch((()=>{d=!1})):d=!1,!d){let e=await t.newUntitled({type:"file",ext:C.chatFileType.extensions[0]});if(i&&(e=await t.rename(e.path,i)),!e)return(0,c.showErrorMessage)("Error creating a chat","An error occurred while creating the chat"),"";i=e.path}if(u.hasCommand(C.CommandIDs.openChat))return u.execute(C.CommandIDs.openChat,{filepath:i,inSidePanel:o});u.execute("docmanager:open",{path:`RTC:${i}`,factory:x})}}),d&&d.addItem({category:"Chat",command:C.CommandIDs.createChat,args:{isPalette:!0}}),h&&h.add({command:C.CommandIDs.createChat,category:"Other"}),u.addCommand(C.CommandIDs.markAsRead,{caption:"Mark chat as read",icon:o.readIcon,isEnabled:()=>null!==g.currentWidget&&g.currentWidget===e.shell.currentWidget&&g.currentWidget.model.unreadMessages.length>0,execute:async t=>{const a=e.shell.currentWidget;a&&a instanceof C.LabChatPanel&&Array.from(e.shell.widgets("main")).includes(a)?a.model.unreadMessages=[]:console.error(`The command '${C.CommandIDs.markAsRead}' should be executed from the toolbar button only`)}}),g.currentChanged.connect((()=>{u.notifyCommandChanged(C.CommandIDs.markAsRead)})),e.serviceManager.ready.then((()=>{const o=e.serviceManager.user.identity;u.addCommand(C.CommandIDs.openChat,{label:"Open a chat",execute:async s=>{var d,h,g,y;const v=null!==(d=s.inSidePanel)&&void 0!==d&&d;let f=null!==(h=s.filepath)&&void 0!==h?h:null;if(null===f&&(f=(await c.InputDialog.getText({label:"File path",placeholder:"/path/to/the/chat/file",title:"Path of the chat"})).value),!f)return;let I=!0;if(await t.get(f,{content:!1}).catch((()=>{I=!1})),I)if(v&&i){if(e.shell instanceof n.NotebookShell){const t=e.shell;(null===(y=null===(g=t.leftHandler)||void 0===g?void 0:g.currentWidget)||void 0===y?void 0:y.id)===i.id&&t.leftHandler.isVisible||t.activateById(i.id)}else e.shell.activateById(i.id);if(i.openIfExists(f))return;const c=await t.get(f),s=t.sharedModelFactory.createNew({path:c.path,format:c.format,contentType:C.chatFileType.contentType,collaborative:!0}),d=new C.LabChatModel({user:o,sharedModel:s,widgetConfig:p,commands:u,activeCellManager:r,selectionWatcher:m,documentManager:null==l?void 0:l.model.manager});d.name=c.path;const h=i.addChat(d);a.tracker.add(h)}else u.execute("docmanager:open",{path:`RTC:${f}`,factory:x});else(0,c.showErrorMessage)("Error opening chat",`'${f}' is not a valid path`)}}),d&&d.addItem({category:"Chat",command:C.CommandIDs.openChat})})).catch((e=>console.error("The command to open a chat is not initialized\n",e))),u.addCommand(C.CommandIDs.focusInput,{caption:"Focus the input of the current chat widget",isEnabled:()=>null!==g.currentWidget,execute:()=>{const t=g.currentWidget;t&&(t instanceof o.ChatWidget&&i?(e.shell.activateById(i.id),i.openIfExists(t.model.name)):e.shell.activateById(t.id),t.model.input.focus())}})}},k={id:"jupyterlab-chat-extension:chat-panel",description:"The chat panel widget.",autoStart:!0,provides:C.IChatPanel,requires:[C.IChatFactory,r.ICollaborativeDrive,m.IRenderMimeRegistry],optional:[o.IAttachmentOpenerRegistry,o.IChatCommandRegistry,C.IInputToolbarRegistryFactory,i.ILayoutRestorer,o.IMessageFooterRegistry,c.IThemeManager,C.IWelcomeMessage],activate:(e,t,a,n,r,i,c,s,d,l,h)=>{const{commands:m}=e,u=t.widgetConfig.config.defaultDirectory||"",g=new C.ChatPanel({commands:m,drive:a,rmRegistry:n,themeManager:l,defaultDirectory:u,chatCommandRegistry:i,attachmentOpenerRegistry:r,inputToolbarFactory:c,messageFooterRegistry:d,welcomeMessage:h});g.id="JupyterlabChat:sidepanel",g.title.icon=o.chatIcon,g.title.caption="Jupyter Chat",t.widgetConfig.configChanged.connect(((e,t)=>{void 0!==t.defaultDirectory&&(g.defaultDirectory=t.defaultDirectory)})),e.shell.add(g,"left",{rank:2e3}),s&&s.add(g,"jupyter-chat");const y=["create","delete","rename"];return e.serviceManager.events.stream.connect(((e,t)=>{if("https://events.jupyter.org/jupyter_server/contents_service/v1"===t.schema_id){const e=t.action;y.includes(e)&&t.path.endsWith(C.chatFileType.extensions[0])&&g.updateChatList()}})),m.addCommand(C.CommandIDs.moveToSide,{label:"Move the chat to the side panel",caption:"Move the chat to the side panel",icon:p.launchIcon,isEnabled:()=>m.hasCommand(C.CommandIDs.openChat),execute:async()=>{const t=e.shell.currentWidget;if(!(t&&t instanceof C.LabChatPanel&&Array.from(e.shell.widgets("main")).includes(t)))return void console.error(`The command '${C.CommandIDs.moveToSide}' should be executed from the toolbar button only`);const a=t.context.path.split(":").pop();m.execute(C.CommandIDs.openChat,{filepath:a,inSidePanel:!0}),t.dispose()}}),g}},S={id:"jupyterlab-chat-extension:activeCellManager",description:"The active cell manager plugin.",autoStart:!0,requires:[h.INotebookTracker],provides:C.IActiveCellManagerToken,activate:(e,t)=>new o.ActiveCellManager({tracker:t,shell:e.shell})},P={id:"jupyterlab-chat-extension:selectionWatcher",description:"The selection watcher plugin.",autoStart:!0,provides:C.ISelectionWatcherToken,activate:e=>new o.SelectionWatcher({shell:e.shell})},_={id:"jupyterlab-chat-extension:inputToolbarFactory",description:"The input toolbar registry plugin.",autoStart:!0,provides:C.IInputToolbarRegistryFactory,activate:e=>({create:()=>o.InputToolbarRegistry.defaultToolbarRegistry()})},E=[S,D,j,v,k,F,{id:"jupyterlab-chat/footerRegistry",description:"The footer registry plugin.",autoStart:!0,provides:o.IMessageFooterRegistry,activate:e=>new o.MessageFooterRegistry},_,P,I,T]}}]);